<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=victor+mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xychen5.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12,"width":300},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"changyan":{"text":"Load Disqus","order":-2},"gitalk":{"order":-1}}},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"zoomIn","post_header":"zoomIn","post_body":"zoomIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

  <meta name="description" content="Freiheit Weht">
<meta property="og:type" content="website">
<meta property="og:title" content="LuftBallon">
<meta property="og:url" content="https://xychen5.github.io/page/6/index.html">
<meta property="og:site_name" content="LuftBallon">
<meta property="og:description" content="Freiheit Weht">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="xychen5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://xychen5.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LuftBallon</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LuftBallon</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-arrow-right fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xychen5"
      src="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
  <p class="site-author-name" itemprop="name">xychen5</p>
  <div class="site-description" itemprop="description">Freiheit Weht</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xychen5?tab=repositories" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xychen5?tab&#x3D;repositories" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cxynash5@gmail.com" title="E-Mail → mailto:cxynash5@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/07/17/freeImageTocvMat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/17/freeImageTocvMat/" class="post-title-link" itemprop="url">freeImageTocvMat&1channelTo3channes - freeimage转到cvmat & 单通道图像转到3通道</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-17 18:51:52" itemprop="dateCreated datePublished" datetime="2021-07-17T18:51:52+08:00">2021-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-结果"><a href="#0-结果" class="headerlink" title="0 结果"></a>0 结果</h2><p><img src="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/freeImg2cvMat.7hbdeyhx4n80.PNG" alt="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/freeImg2cvMat.7hbdeyhx4n80.PNG"></p>
<h2 id="1-代码"><a href="#1-代码" class="headerlink" title="1 代码"></a>1 代码</h2><p>将freeImage转为cv::mat，代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;FreeImage.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;opencv2\opencv.hpp&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// #define _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable : 4996)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FI2MAT</span><span class="params">(FIBITMAP* src, Mat&amp; dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//FIT_BITMAP    //standard image : 1 - , 4 - , 8 - , 16 - , 24 - , 32 - bit</span></span><br><span class="line">    <span class="comment">//FIT_UINT16    //array of unsigned short : unsigned 16 - bit</span></span><br><span class="line">    <span class="comment">//FIT_INT16     //array of short : signed 16 - bit</span></span><br><span class="line">    <span class="comment">//FIT_UINT32    //array of unsigned long : unsigned 32 - bit</span></span><br><span class="line">    <span class="comment">//FIT_INT32     //array of long : signed 32 - bit</span></span><br><span class="line">    <span class="comment">//FIT_FLOAT     //array of float : 32 - bit IEEE floating point</span></span><br><span class="line">    <span class="comment">//FIT_DOUBLE    //array of double : 64 - bit IEEE floating point</span></span><br><span class="line">    <span class="comment">//FIT_COMPLEX   //array of FICOMPLEX : 2 x 64 - bit IEEE floating point</span></span><br><span class="line">    <span class="comment">//FIT_RGB16     //48 - bit RGB image : 3 x 16 - bit</span></span><br><span class="line">    <span class="comment">//FIT_RGBA16    //64 - bit RGBA image : 4 x 16 - bit</span></span><br><span class="line">    <span class="comment">//FIT_RGBF      //96 - bit RGB float image : 3 x 32 - bit IEEE floating point</span></span><br><span class="line">    <span class="comment">//FIT_RGBAF     //128 - bit RGBA float image : 4 x 32 - bit IEEE floating point</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> bpp = <span class="built_in">FreeImage_GetBPP</span>(src);</span><br><span class="line">    FREE_IMAGE_TYPE fit = <span class="built_in">FreeImage_GetImageType</span>(src);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> cv_type = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> cv_cvt = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (fit)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> FIT_UINT16: cv_type = DataType&lt;ushort&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_INT16: cv_type = DataType&lt;<span class="type">short</span>&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_UINT32: cv_type = DataType&lt;<span class="type">unsigned</span>&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_INT32: cv_type = DataType&lt;<span class="type">int</span>&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_FLOAT: cv_type = DataType&lt;<span class="type">float</span>&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_DOUBLE: cv_type = DataType&lt;<span class="type">double</span>&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_COMPLEX: cv_type = DataType&lt;Complex&lt;<span class="type">double</span>&gt;&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_RGB16: cv_type = DataType&lt;Vec&lt;ushort, <span class="number">3</span>&gt;&gt;::type; cv_cvt = COLOR_RGB2BGR; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_RGBA16: cv_type = DataType&lt;Vec&lt;ushort, <span class="number">4</span>&gt;&gt;::type; cv_cvt = COLOR_RGBA2BGRA; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_RGBF: cv_type = DataType&lt;Vec&lt;<span class="type">float</span>, <span class="number">3</span>&gt;&gt;::type; cv_cvt = COLOR_RGB2BGR; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_RGBAF: cv_type = DataType&lt;Vec&lt;<span class="type">float</span>, <span class="number">4</span>&gt;&gt;::type; cv_cvt = COLOR_RGBA2BGRA; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIT_BITMAP:</span><br><span class="line">        <span class="keyword">switch</span> (bpp) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>: cv_type = DataType&lt;Vec&lt;uchar, <span class="number">1</span>&gt;&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>: cv_type = DataType&lt;Vec&lt;uchar, <span class="number">2</span>&gt;&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">24</span>: cv_type = DataType&lt;Vec&lt;uchar, <span class="number">3</span>&gt;&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>: cv_type = DataType&lt;Vec&lt;uchar, <span class="number">4</span>&gt;&gt;::type; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 1, 4 // Unsupported natively</span></span><br><span class="line">            cv_type = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// FIT_UNKNOWN // unknown type</span></span><br><span class="line">        dst = <span class="built_in">Mat</span>(); <span class="comment">// return empty Mat</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> width = <span class="built_in">FreeImage_GetWidth</span>(src);</span><br><span class="line">    <span class="type">int</span> height = <span class="built_in">FreeImage_GetHeight</span>(src);</span><br><span class="line">    <span class="type">int</span> step = <span class="built_in">FreeImage_GetPitch</span>(src);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cv_type &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        dst = <span class="built_in">Mat</span>(height, width, cv_type, <span class="built_in">FreeImage_GetBits</span>(src), step);</span><br><span class="line">        <span class="keyword">if</span> (cv_cvt &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cvtColor</span>(dst, dst, cv_cvt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        std::vector&lt;uchar&gt; lut;</span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">pow</span>(<span class="number">2</span>, bpp);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            lut.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;uchar&gt;((<span class="number">255</span> / (n - <span class="number">1</span>))*i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FIBITMAP* palletized = <span class="built_in">FreeImage_ConvertTo8Bits</span>(src);</span><br><span class="line">        BYTE* data = <span class="built_in">FreeImage_GetBits</span>(src);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> r = <span class="number">0</span>; r &lt; height; ++r) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; width; ++c) &#123;</span><br><span class="line">                dst.<span class="built_in">at</span>&lt;uchar&gt;(r, c) = <span class="built_in">saturate_cast</span>&lt;uchar&gt;(lut[data[r*step + c]]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">flip</span>(dst, dst, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">FreeImage_Initialise</span>();</span><br><span class="line">    <span class="comment">// std::string imgPath = &quot;F:/cppTry/index3.png&quot;;</span></span><br><span class="line">    std::string imgPath = <span class="string">&quot;F:/cppTry/ger.JPG&quot;</span>;</span><br><span class="line">    FREE_IMAGE_FORMAT format = <span class="built_in">FreeImage_GetFileType</span>(imgPath.<span class="built_in">c_str</span>(), <span class="number">0</span>);</span><br><span class="line">    FIBITMAP* fi_image = <span class="built_in">FreeImage_Load</span>(format, imgPath.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    Mat cvImg2;</span><br><span class="line">    <span class="built_in">FI2MAT</span>(fi_image, cvImg2);</span><br><span class="line">    <span class="built_in">cvNamedWindow</span>(<span class="string">&quot;Image1:&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    cv::<span class="built_in">imshow</span>(<span class="string">&quot;Image1:&quot;</span>,cvImg2);</span><br><span class="line">    <span class="comment">// imshow(cv_img);</span></span><br><span class="line"></span><br><span class="line">    IplImage *img = <span class="built_in">cvLoadImage</span>(imgPath.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">cvNamedWindow</span>(<span class="string">&quot;Image2:&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">cvShowImage</span>(<span class="string">&quot;Image2:&quot;</span>, img);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[free&#x27;s conv]: type is: &quot;</span>    &lt;&lt; <span class="built_in">FreeImage_GetColorType</span>(fi_image) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[free&#x27;s conv]: depth is: &quot;</span>   &lt;&lt; <span class="built_in">FreeImage_GetBPP</span>(fi_image) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[free&#x27;s conv]: pitch is: &quot;</span>   &lt;&lt; <span class="built_in">FreeImage_GetPitch</span>(fi_image) &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[cv2 conv]: type is: &quot;</span> &lt;&lt;  <span class="string">&quot;/&quot;</span> &lt;&lt; cvImg2.<span class="built_in">type</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[cv2 conv]: depth is: &quot;</span> &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; cvImg2.<span class="built_in">depth</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[cv2 conv]: channel is: &quot;</span> &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; cvImg2.<span class="built_in">channels</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[cv2 conv]: elem size is: &quot;</span> &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; cvImg2.<span class="built_in">elemSize</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cvWaitKey</span>();</span><br><span class="line">    <span class="built_in">cvDestroyWindow</span>(<span class="string">&quot;Image:&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-将1通道转为3通道"><a href="#2-将1通道转为3通道" class="headerlink" title="2 将1通道转为3通道"></a>2 将1通道转为3通道</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">convert1to3Channel</span><span class="params">(cv::Mat&amp; src, cv::Mat&amp; dst)</span> </span>&#123;</span><br><span class="line">    vector&lt;cv::Mat&gt; channels;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        channels.<span class="built_in">push_back</span>(src);</span><br><span class="line">    &#125;</span><br><span class="line">    cv::<span class="built_in">merge</span>(&amp;channels[<span class="number">0</span>], channels.<span class="built_in">size</span>(), dst);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/07/17/pangolinDynamicPly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/17/pangolinDynamicPly/" class="post-title-link" itemprop="url">pangolinDynamicPly.md</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-17 17:44:13" itemprop="dateCreated datePublished" datetime="2021-07-17T17:44:13+08:00">2021-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-结果展示"><a href="#0-结果展示" class="headerlink" title="0 结果展示"></a>0 结果展示</h2><p><img src="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/dynamicPly.4903brhv6b00.gif" alt="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/dynamicPly.4903brhv6b00.gif"></p>
<h2 id="1-下载编译pangolin的库"><a href="#1-下载编译pangolin的库" class="headerlink" title="1 下载编译pangolin的库"></a>1 下载编译pangolin的库</h2><p><a target="_blank" rel="noopener" href="https://github.com/stevenlovegrove/Pangolin.git">https://github.com/stevenlovegrove/Pangolin.git</a><br>该库中本身含有libpng, libjpg, libzip</p>
<h2 id="2-当需要调用该库时："><a href="#2-当需要调用该库时：" class="headerlink" title="2 当需要调用该库时："></a>2 当需要调用该库时：</h2><p>调用时依赖如下：(本项目并未上传所有依赖，部分依赖需要单独下载然后放到thirdparty目录里)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># include</span></span><br><span class="line">F:\prjs\ORB_SLAM3_Fix\ORB_SLAM3\Thirdparty\Pangolin\include;F:\prjs\ORB_SLAM3_Fix\ORB_SLAM3\Thirdparty\Pangolin\build\src\include;F:\prjs\ORB_SLAM3_Fix\ORB_SLAM3\Thirdparty\Pangolin\build\external\glew\include;F:\BASE_ENV\forOpenMVS\eigen;%(AdditionalIncludeDirectories)</span><br><span class="line"></span><br><span class="line"><span class="comment"># lib</span></span><br><span class="line">..\..\..\lib\Release\pangolin.lib;opengl32.lib;glu32.lib;..\..\external\glew\lib\glew.lib;..\..\external\libpng\lib\libpng16_static.lib;..\..\external\zlib\lib\zlibstatic.lib;..\..\external\libjpeg\lib\jpeg.lib;kernel32.lib;user32.lib;gdi32.lib;winspool.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;comdlg32.lib;advapi32.lib</span><br></pre></td></tr></table></figure>

<h2 id="3-动态展示点云的示例："><a href="#3-动态展示点云的示例：" class="headerlink" title="3 动态展示点云的示例："></a>3 动态展示点云的示例：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">viewThread</span><span class="params">(pangolin::OpenGlMatrix &amp;Twc)</span> </span>&#123;</span><br><span class="line">	pangolin::<span class="built_in">CreateWindowAndBind</span>(<span class="string">&quot;Main&quot;</span>, <span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">	<span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">	<span class="comment">// Issue specific OpenGl we might need</span></span><br><span class="line">	<span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">	<span class="built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Define Projection and initial ModelView matrix</span></span><br><span class="line">	<span class="function">pangolin::OpenGlRenderState <span class="title">s_cam</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		pangolin::ProjectionMatrix(<span class="number">1024</span>, <span class="number">768</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">512</span>, <span class="number">389</span>, <span class="number">0.1</span>, <span class="number">1000</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">		pangolin::ModelViewLookAt(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, pangolin::AxisY)</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line">	<span class="built_in">glClearColor</span>(<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">	 <span class="comment">// Add named OpenGL viewport to window and provide 3D Handler</span></span><br><span class="line">	 pangolin::View&amp; d_cam = pangolin::<span class="built_in">CreateDisplay</span>()</span><br><span class="line">	 	.<span class="built_in">SetBounds</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, pangolin::Attach::<span class="built_in">Pix</span>(<span class="number">175</span>), <span class="number">1.0</span>, <span class="number">-1024.0f</span> / <span class="number">768.0f</span>)</span><br><span class="line">	 	.<span class="built_in">SetHandler</span>(<span class="keyword">new</span> pangolin::<span class="built_in">Handler3D</span>(s_cam));</span><br><span class="line">	</span><br><span class="line">	<span class="type">size_t</span> frame = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( !pangolin::<span class="built_in">ShouldQuit</span>() ) &#123;</span><br><span class="line">        <span class="comment">// Clear screen and activate view to render into</span></span><br><span class="line">        <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">		<span class="built_in">glClearColor</span>(<span class="number">1.0f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span>);</span><br><span class="line">        <span class="comment">//! Activate Displays and set State Matrices</span></span><br><span class="line">        d_cam.<span class="built_in">Activate</span>(s_cam);</span><br><span class="line">		<span class="comment">// draw camera</span></span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> w = <span class="number">2</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> h = w*<span class="number">0.75</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">float</span> z = w*<span class="number">0.6</span>;</span><br><span class="line">        <span class="built_in">glPushMatrix</span>();</span><br><span class="line">		<span class="built_in">glMultMatrixd</span>(Twc.m);</span><br><span class="line">        <span class="built_in">glLineWidth</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">glColor3f</span>(<span class="number">0.0f</span>,<span class="number">1.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">        <span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,-h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,-h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,h,z);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,-h,z);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,-h,z);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,h,z);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glVertex3f</span>(-w,-h,z);</span><br><span class="line">        <span class="built_in">glVertex3f</span>(w,-h,z);</span><br><span class="line">        <span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">glPopMatrix</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// draw points</span></span><br><span class="line">		<span class="built_in">glPointSize</span>(<span class="number">2</span>);</span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POINTS);</span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// get all points to m_pos.m_ppatches</span></span><br><span class="line">		updatePointsMutex.<span class="built_in">lock</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">size_t</span> p = <span class="number">0</span>; p &lt; (<span class="type">size_t</span>)allPPatchesRender.<span class="built_in">size</span>(); ++p)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">auto</span> patch = *allPPatchesRender[p];</span><br><span class="line">			<span class="built_in">glVertex3f</span>(</span><br><span class="line">				patch.m_coord[<span class="number">0</span>],</span><br><span class="line">				patch.m_coord[<span class="number">1</span>],</span><br><span class="line">				patch.m_coord[<span class="number">2</span>]</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">        updatePointsMutex.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Swap frames and Process Events</span></span><br><span class="line">        pangolin::<span class="built_in">FinishFrame</span>();</span><br><span class="line">        </span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>)); <span class="comment">// ms</span></span><br><span class="line">		<span class="comment">// std::cout &lt;&lt; &quot;frame��&quot; &lt;&lt; ++frame &lt;&lt; std::endl;</span></span><br><span class="line">		<span class="comment">// std::cout &lt;&lt; &quot;point nums are: &quot; &lt;&lt; findMatch-&gt;m_pos.m_ppatches.size() &lt;&lt; std::endl;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pangolin::OpenGlMatrix Twc, Twr;</span><br><span class="line">	Twc.<span class="built_in">SetIdentity</span>();</span><br><span class="line">	<span class="function">std::thread <span class="title">viewThd</span><span class="params">(viewThread, Twc)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">...&lt;省略&gt;</span><br><span class="line">        <span class="comment">// update render points</span></span><br><span class="line">        updatePointsMutex.<span class="built_in">lock</span>();</span><br><span class="line">        allPPatchesRender = findMatch-&gt;m_pos.m_ppatches; <span class="comment">// to get the newest points</span></span><br><span class="line">        updatePointsMutex.<span class="built_in">unlock</span>();</span><br><span class="line">...&lt;省略&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	viewThd.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//writePointCloundPly(prefix);</span></span><br><span class="line">	<span class="built_in">releasePMVS</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/06/15/osgPtr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/15/osgPtr/" class="post-title-link" itemprop="url">osg智能指针错误 - Warning deleting still referenced object</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-15 18:24:49" itemprop="dateCreated datePublished" datetime="2021-06-15T18:24:49+08:00">2021-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/errors/" itemprop="url" rel="index"><span itemprop="name">errors</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-osg智能指针错误-Warning-deleting-still-referenced-object"><a href="#1-osg智能指针错误-Warning-deleting-still-referenced-object" class="headerlink" title="1 osg智能指针错误 - Warning: deleting still referenced object"></a>1 osg智能指针错误 - Warning: deleting still referenced object</h2><h3 id="1-1-问题描述"><a href="#1-1-问题描述" class="headerlink" title="1.1 问题描述"></a>1.1 问题描述</h3><p>类的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QOsgWidget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">///&lt; essential widget, use this ptr to be the real widget</span></span><br><span class="line">    osgQOpenGLWidget* pWidget = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// QOsgWidget(QWidget* parent = nullptr);</span></span><br><span class="line">    <span class="built_in">QOsgWidget</span>(<span class="type">const</span> std::string&amp; modelPath, QWidget* parent = <span class="literal">nullptr</span>);</span><br><span class="line">    ~<span class="built_in">QOsgWidget</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">///&lt; osg base vars</span></span><br><span class="line">    osg::ref_ptr&lt;osg::Group&gt;                        mRoot                = <span class="literal">nullptr</span>; <span class="comment">// root node of the osg scene</span></span><br><span class="line">    osg::ref_ptr&lt;osg::Camera&gt;                       camera               = <span class="literal">nullptr</span>; <span class="comment">// osg camera</span></span><br><span class="line">    osg::ref_ptr&lt;osgViewer::Viewer&gt;                 mViewer              = <span class="literal">nullptr</span>; <span class="comment">// osg viewer</span></span><br><span class="line">    osg::ref_ptr&lt;osgGA::TrackballManipulator&gt;       trackball            = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgGA::KeySwitchMatrixManipulator&gt; keyswitchManipulator = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgViewer::StatsHandler&gt;           stats                = <span class="literal">nullptr</span>;</span><br><span class="line">    &lt;被省略&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类的析构函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">QOsgWidget::~<span class="built_in">QOsgWidget</span>() &#123;</span><br><span class="line">    <span class="comment">// end the render thread and destroy the osgOpenglWidget</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    mViewer-&gt;<span class="built_in">setDone</span>(<span class="literal">true</span>);</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    mViewer-&gt;<span class="built_in">stopThreading</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">/// without folowing post process, u will crash with the bellowing warning when: delete pWidget</span></span><br><span class="line">    <span class="comment">/// Warning: deleting still referenced object 000002433CA59BB0 of type &#x27;class osg::Referenced * __ptr64&#x27;</span></span><br><span class="line">    <span class="comment">///     the final reference count was 1, memory corruption possible.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// the reason i guess is:</span></span><br><span class="line">    <span class="comment">/// the bellowing vars can not be automatically set to null when delete pWidget, because they does</span></span><br><span class="line">    <span class="comment">/// not belong to the pWidget, so u need to set them to null manually, otherwise when delete pWidget,</span></span><br><span class="line">    <span class="comment">/// the destructor of pWidget will try to free the bellowing vars, but their ref != 0</span></span><br><span class="line">    <span class="comment">///////////////////////////////// PART 1 /////////////////////////////////</span></span><br><span class="line">        mRoot = <span class="literal">nullptr</span>;</span><br><span class="line">        mViewer = <span class="literal">nullptr</span>;</span><br><span class="line">        camera = <span class="literal">nullptr</span>;</span><br><span class="line">        trackball = <span class="literal">nullptr</span>;</span><br><span class="line">        keyswitchManipulator = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> pWidget; <span class="comment">// call the destructor of the osgOpenglWidge</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题描述，在执行类的析构的时候：<br>当没有PART1的时候，直接执行pWidget会出错</p>
<h3 id="1-2-原因推测："><a href="#1-2-原因推测：" class="headerlink" title="1.2 原因推测："></a>1.2 原因推测：</h3><ul>
<li>1 osg::ref_ptr&lt;&gt; 是一种智能指针，自动计算指针的引用个数，当引用个数为0的时候，自动回收其指向的对象。</li>
<li>2 于是出现一个大问题，当pWidget这个类指针所指向的类，里面很多组件（比如 camera，mViewer）是在QOsgWidget类中申明的，那么当析构pWidget的时候，它会去析构自己的组件，然后当它析构了自己类里面的那些指针后，发现QOsgWidget里面的智能指针不是null（这些指针很可能在被别的模块访问），所以引用计数不为0，所以无法删除，或者删除会crash</li>
</ul>
<h3 id="1-3-得出结论："><a href="#1-3-得出结论：" class="headerlink" title="1.3 得出结论："></a>1.3 得出结论：</h3><ul>
<li>1 如果类mon里面嵌套了类son，那么当mon的析构的时候，要注意如下两点：<ul>
<li>1.1 将son析构</li>
<li>1.2 执行son的析构前，对son的析构可能产生影响的内存，指针，都要释放掉和置空</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/06/06/wildptr2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/06/wildptr2/" class="post-title-link" itemprop="url">wildptr2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-06 21:04:21" itemprop="dateCreated datePublished" datetime="2021-06-06T21:04:21+08:00">2021-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/errors/" itemprop="url" rel="index"><span itemprop="name">errors</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="2-关于内存申请位置不对带来的野指针问题"><a href="#2-关于内存申请位置不对带来的野指针问题" class="headerlink" title="2 关于内存申请位置不对带来的野指针问题"></a>2 关于内存申请位置不对带来的野指针问题</h3><h4 id="2-1-问题描述："><a href="#2-1-问题描述：" class="headerlink" title="2.1 问题描述："></a>2.1 问题描述：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">            <span class="built_in">resize</span>(<span class="built_in">height</span>() * <span class="number">639</span> / <span class="number">480</span>, <span class="built_in">height</span>());</span><br><span class="line">            QOsgWidget *bBoxEdit = <span class="keyword">new</span> <span class="built_in">QOsgWidget</span>(modelPath, <span class="built_in">static_cast</span>&lt;QWidget*&gt;(<span class="keyword">this</span>));</span><br><span class="line">            <span class="comment">// use an ArgumentParser object to manage the program arguments.</span></span><br><span class="line">            bBoxEdit-&gt;pWidget = <span class="keyword">new</span> <span class="built_in">osgQOpenGLWidget</span>(&amp;arguments, <span class="keyword">this</span>);</span><br><span class="line">            bBoxEdit-&gt;pWidget-&gt;<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// init the manipulators</span></span><br><span class="line">            bBoxEdit-&gt;<span class="built_in">InitManipulators</span>();</span><br><span class="line">            bBoxEdit-&gt;<span class="built_in">InitModel</span>(modelPath, bBoxEdit-&gt;mRoot);</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************** part0: inside code segment of func call **********************/</span></span><br><span class="line">            osg::ref_ptr&lt;osgViewer::Viewer&gt; mViewer = bBoxEdit-&gt;pWidget-&gt;<span class="built_in">getOsgViewer</span>();</span><br><span class="line">            <span class="comment">// Add a Stats Handler to the viewer</span></span><br><span class="line">            mViewer-&gt;<span class="built_in">addEventHandler</span>(<span class="keyword">new</span> osgViewer::StatsHandler);</span><br><span class="line">            <span class="comment">// Add the Camera to the Viewer</span></span><br><span class="line">            osg::ref_ptr&lt;osg::Camera&gt; camera = mViewer-&gt;<span class="built_in">getCamera</span>();</span><br><span class="line">            <span class="comment">// Set projection matrix and camera attribtues</span></span><br><span class="line">            camera-&gt;<span class="built_in">setClearMask</span>(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</span><br><span class="line">            camera-&gt;<span class="built_in">setClearColor</span>(osg::<span class="built_in">Vec3f</span>(<span class="number">0.2f</span>, <span class="number">0.2f</span>, <span class="number">0.4f</span>, <span class="number">1.0f</span>));</span><br><span class="line">            <span class="comment">//mViewer-&gt;addSlave(camera.get());</span></span><br><span class="line">            mViewer-&gt;<span class="built_in">setCamera</span>(camera.<span class="built_in">get</span>());</span><br><span class="line">            <span class="comment">// Set the Scene Data</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// *************************** part1: func call **********************************/</span></span><br><span class="line">            <span class="comment">// bBoxEdit-&gt;InitCameraConfig();</span></span><br></pre></td></tr></table></figure>
<p>如上代码段，是一段qt程序中，在MainWindow的一个子函数的一段代码，其中bBoxEdit是一个自定义的供调用的类，<br>问题来了， part0的代码就是把part2的代码拿出来，仅仅使用part1的代码就会出错，仅仅使用part2就不会，请推测原因？</p>
<p>这里给出part1的实现代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QOsgWidget::InitCameraConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create the viewer for this window</span></span><br><span class="line">    mViewer = <span class="keyword">this</span>-&gt;pWidget-&gt;<span class="built_in">getOsgViewer</span>();</span><br><span class="line">    <span class="comment">// Add a Stats Handler to the viewer</span></span><br><span class="line">    mViewer-&gt;<span class="built_in">addEventHandler</span>(<span class="keyword">new</span> osgViewer::StatsHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the Camera to the Viewer</span></span><br><span class="line">    osg::ref_ptr&lt;osg::Camera&gt; camera = mViewer-&gt;<span class="built_in">getCamera</span>();</span><br><span class="line">    <span class="comment">// Set projection matrix and camera attribtues</span></span><br><span class="line">    camera-&gt;<span class="built_in">setClearMask</span>(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</span><br><span class="line">    camera-&gt;<span class="built_in">setClearColor</span>(osg::<span class="built_in">Vec3f</span>(<span class="number">0.2f</span>, <span class="number">0.2f</span>, <span class="number">0.4f</span>, <span class="number">1.0f</span>));</span><br><span class="line">    <span class="comment">//mViewer-&gt;addSlave(camera.get());</span></span><br><span class="line">    mViewer-&gt;<span class="built_in">setCamera</span>(camera.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the Camera Manipulator to the Viewer</span></span><br><span class="line">    osg::ref_ptr&lt;osgGA::TrackballManipulator&gt; trackball = <span class="keyword">new</span> osgGA::<span class="built_in">TrackballManipulator</span>();</span><br><span class="line">    mViewer-&gt;<span class="built_in">setCameraManipulator</span>(trackball.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the Scene Data</span></span><br><span class="line">    mViewer-&gt;<span class="built_in">setSceneData</span>(mRoot.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-错误原因推测："><a href="#2-2-错误原因推测：" class="headerlink" title="2.2 错误原因推测："></a>2.2 错误原因推测：</h4><p>首先想到，这肯定是指针带来的问题，指针和作用域和代码范围息息相关，所以放到函数里面和放到mainwindow的一个子函数的随便的一处，最大的区别在于，</p>
<ul>
<li>0 part2的情况：part2里面的函数调用所用到的指针，是存在qosgwidget的类的栈空间的，意味着只要类不析构，那么该指针所指向的内存就不会被回收。</li>
<li>1 part1的情况：part1里面申请的内存是在mainwindow的一个子函数调用里面申请的，意味着该指针，在该子函数调用结束，它指向的内存会被回收，倘若这一块内存里运行的函数是我们恰恰不希望他在函数结束后就消失，那么我们就需要把这个指针存在一个 <strong>‘安全’</strong> 的地方。所以你需要存在哪里？  因为上面可以知道，该指针的内存里的函数是被 qosgwidget这个类所需要的,也就是当这个类结束啦，这个指针才会被回收，所以我们把指针存在这里，就不会出现上面的问题了。</li>
</ul>
<h4 id="2-3-得出结论（个人观点）"><a href="#2-3-得出结论（个人观点）" class="headerlink" title="2.3 得出结论（个人观点）"></a>2.3 得出结论（个人观点）</h4><p>cpp的内存管理问题：</p>
<ul>
<li>0 尽量不要在业务流程里申请内存，释放内存，如果遇到需要申请内存和释放的地方，请把这一块儿写成一个类，<br>用类的变量来保存内存指针，用类的析构来释放内存。</li>
<li>1 <strong>重复1的观点：基于类作为内存管理的最小粒度，不要基于指针</strong></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/06/06/osgQT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/06/osgQT/" class="post-title-link" itemprop="url">osgQT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-06 21:04:07" itemprop="dateCreated datePublished" datetime="2021-06-06T21:04:07+08:00">2021-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-osgQT的移植"><a href="#1-osgQT的移植" class="headerlink" title="1 osgQT的移植"></a>1 osgQT的移植</h3><p>首先参考官方项目：<br><a target="_blank" rel="noopener" href="https://github.com/openscenegraph/osgQt">https://github.com/openscenegraph/osgQt</a></p>
<p>这里先给出结果图：<br><img src="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/gliderQT.1w4nlzuxphsw.png" alt="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/gliderQT.1w4nlzuxphsw.png"></p>
<h4 id="1-1-修改osgviewerqt-cpp如下：-这样你就能自己读模型了"><a href="#1-1-修改osgviewerqt-cpp如下：-这样你就能自己读模型了" class="headerlink" title="1.1 修改osgviewerqt.cpp如下： 这样你就能自己读模型了"></a>1.1 修改osgviewerqt.cpp如下： 这样你就能自己读模型了</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgQOpenGL/osgQOpenGLWidget&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgDB/ReadFile&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgUtil/Optimizer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osg/CoordinateSystemNode&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osg/Switch&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osg/Types&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgViewer/Viewer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgText/Text&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgViewer/Viewer&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgViewer/ViewerEventHandlers&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/TrackballManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/FlightManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/DriveManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/KeySwitchMatrixManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/StateSetManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/AnimationPathManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/TerrainManipulator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/SphericalManipulator&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osgGA/Device&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSurfaceFormat&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">( <span class="type">int</span> argc, <span class="type">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    QSurfaceFormat format = QSurfaceFormat::<span class="built_in">defaultFormat</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> OSG_GL3_AVAILABLE</span></span><br><span class="line">    format.<span class="built_in">setVersion</span>(<span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">    format.<span class="built_in">setProfile</span>(QSurfaceFormat::CoreProfile);</span><br><span class="line">    format.<span class="built_in">setRenderableType</span>(QSurfaceFormat::OpenGL);</span><br><span class="line">    format.<span class="built_in">setOption</span>(QSurfaceFormat::DebugContext);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    format.<span class="built_in">setVersion</span>(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    format.<span class="built_in">setProfile</span>(QSurfaceFormat::CompatibilityProfile);</span><br><span class="line">    format.<span class="built_in">setRenderableType</span>(QSurfaceFormat::OpenGL);</span><br><span class="line">    format.<span class="built_in">setOption</span>(QSurfaceFormat::DebugContext);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    format.<span class="built_in">setDepthBufferSize</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="comment">//format.setAlphaBufferSize(8);</span></span><br><span class="line">    format.<span class="built_in">setSamples</span>(<span class="number">8</span>);</span><br><span class="line">    format.<span class="built_in">setStencilBufferSize</span>(<span class="number">8</span>);</span><br><span class="line">    format.<span class="built_in">setSwapBehavior</span>(QSurfaceFormat::DoubleBuffer);</span><br><span class="line">    QSurfaceFormat::<span class="built_in">setDefaultFormat</span>(format);</span><br><span class="line"></span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use an ArgumentParser object to manage the program arguments.</span></span><br><span class="line">    <span class="function">osg::ArgumentParser <span class="title">arguments</span><span class="params">(&amp;argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">setApplicationName</span>(</span><br><span class="line">        arguments.<span class="built_in">getApplicationName</span>());</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">setDescription</span>(arguments.<span class="built_in">getApplicationName</span>() +</span><br><span class="line">                                                    <span class="string">&quot; is the standard OpenSceneGraph example which loads and visualises 3d models.&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">setCommandLineUsage</span>(</span><br><span class="line">        arguments.<span class="built_in">getApplicationName</span>() + <span class="string">&quot; [options] filename ...&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;--image &lt;filename&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Load an image and render it on a quad&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;--dem &lt;filename&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Load an image/DEM and render it on a HeightField&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;--login &lt;url&gt; &lt;username&gt; &lt;password&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Provide authentication information for http file access.&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;-p &lt;filename&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Play specified camera path animation file, previously saved with &#x27;z&#x27; key.&quot;</span>, </span><br><span class="line">                                                          <span class="string">&quot;F:/dataSets/OpenSceneGraph-Data-3.4.0/OpenSceneGraph-Data/glider.osg&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;--speed &lt;factor&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Speed factor for animation playing (1 == normal speed).&quot;</span>);</span><br><span class="line">    arguments.<span class="built_in">getApplicationUsage</span>()-&gt;<span class="built_in">addCommandLineOption</span>(<span class="string">&quot;--device &lt;device-name&gt;&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;add named device to the viewer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">osgQOpenGLWidget <span class="title">widget</span><span class="params">(&amp;arguments)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        osg::ref_ptr&lt;osg::Node&gt; loadedModel = osgDB::<span class="built_in">readNodeFile</span>(<span class="string">&quot;F:/dataSets/OpenSceneGraph-Data-3.4.0/OpenSceneGraph-Data/glider.osg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!loadedModel)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; arguments.<span class="built_in">getApplicationName</span>() &lt;&lt; <span class="string">&quot;: No data loaded&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// any option left unread are converted into errors to write out later.</span></span><br><span class="line">        arguments.<span class="built_in">reportRemainingOptionsAsUnrecognized</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// report any errors if they have occurred when parsing the program arguments.</span></span><br><span class="line">        <span class="keyword">if</span> (arguments.<span class="built_in">errors</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            arguments.<span class="built_in">writeErrorMessages</span>(std::cout);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        widget.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// optimize the scene graph, remove redundant nodes and state etc.</span></span><br><span class="line">        osgUtil::Optimizer optimizer;</span><br><span class="line">        optimizer.<span class="built_in">optimize</span>(loadedModel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mViewer = new osgViewer::Viewer();</span></span><br><span class="line">        osg::ref_ptr&lt;osgViewer::Viewer&gt; mViewer = widget.<span class="built_in">getOsgViewer</span>();</span><br><span class="line">       </span><br><span class="line">    		osg::ref_ptr&lt;osg::Camera&gt; camera = mViewer-&gt;<span class="built_in">getCamera</span>();</span><br><span class="line"></span><br><span class="line">        camera-&gt;<span class="built_in">setClearMask</span>(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</span><br><span class="line">        camera-&gt;<span class="built_in">setClearColor</span>(osg::<span class="built_in">Vec4f</span>(<span class="number">0.2f</span>, <span class="number">0.2f</span>, <span class="number">0.4f</span>, <span class="number">1.0f</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the Camera to the Viewer</span></span><br><span class="line">        mViewer-&gt;<span class="built_in">setCamera</span>(camera.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the Camera Manipulator to the Viewer</span></span><br><span class="line">        <span class="comment">// mViewer-&gt;setCameraManipulator(keyswitchManipulator.get());</span></span><br><span class="line">        osg::ref_ptr&lt;osgGA::TrackballManipulator&gt; trackball = <span class="keyword">new</span> osgGA::<span class="built_in">TrackballManipulator</span>();</span><br><span class="line">        mViewer-&gt;<span class="built_in">setCameraManipulator</span>(trackball.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">        mViewer-&gt;<span class="built_in">setSceneData</span>(loadedModel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// // Realize the Viewer&#x27;s graphics context, which already done in the default pWidget</span></span><br><span class="line">        <span class="comment">// mViewer-&gt;realize(); </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-qt中使用"><a href="#1-2-qt中使用" class="headerlink" title="1.2 qt中使用"></a>1.2 qt中使用</h4><ul>
<li><p>1 封装一个自己的类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;osgHeaders.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * this class is mainly for initialize the pWidget</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QOsgWidget</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// essential widget, use this ptr to be the real widget</span></span><br><span class="line">    osgQOpenGLWidget* pWidget = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// QOsgWidget(QWidget* parent = nullptr);</span></span><br><span class="line">    <span class="built_in">QOsgWidget</span>(<span class="type">const</span> std::string&amp; modelPath, QWidget* parent = <span class="literal">nullptr</span>);</span><br><span class="line">    ~<span class="built_in">QOsgWidget</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// osg base vars</span></span><br><span class="line">    osg::ref_ptr&lt;osg::Group&gt;                        mRoot                = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osg::Camera&gt;                       camera               = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgViewer::Viewer&gt;                 mViewer              = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgGA::TrackballManipulator&gt;       trackball            = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgGA::KeySwitchMatrixManipulator&gt; keyswitchManipulator = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for experiment:</span></span><br><span class="line">    osg::ref_ptr&lt;osgViewer::StatsHandler&gt; pStat = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgGA::TrackballManipulator&gt; pTrackball = <span class="literal">nullptr</span>;</span><br><span class="line">    osg::ref_ptr&lt;osgViewer::Viewer&gt; pmViewer = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// osg base funcs</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">InitManipulators</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// load model into the mRoot</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">InitModel</span><span class="params">(<span class="type">const</span> std::string&amp; modelPathm, osg::ref_ptr&lt;osg::Group&gt;&amp; mRoot)</span></span>;</span><br><span class="line">    <span class="comment">// init the cmaera</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">InitCameraConfig</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">osg::ref_ptr&lt;osgViewer::Viewer&gt; <span class="title">getViewer</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> mViewer; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// QObject::connect(&amp;widget, &amp;osgQOpenGLWidget::initialized);</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>2 调用这个类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">QOsgWidget *bBoxEdit = <span class="keyword">new</span> <span class="built_in">QOsgWidget</span>(modelPath, <span class="built_in">static_cast</span>&lt;QWidget*&gt;(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// use an ArgumentParser object to manage the program arguments.</span></span><br><span class="line">bBoxEdit-&gt;pWidget = <span class="keyword">new</span> <span class="built_in">osgQOpenGLWidget</span>(&amp;arguments, <span class="keyword">this</span>);</span><br><span class="line">bBoxEdit-&gt;pWidget-&gt;<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// init the manipulators</span></span><br><span class="line">bBoxEdit-&gt;<span class="built_in">InitManipulators</span>();</span><br><span class="line"><span class="comment">// init Scene Graph, that is to load the model</span></span><br><span class="line">bBoxEdit-&gt;<span class="built_in">InitModel</span>(modelPath, bBoxEdit-&gt;mRoot);</span><br><span class="line"><span class="comment">// init camera config</span></span><br><span class="line">bBoxEdit-&gt;<span class="built_in">InitCameraConfig</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这一行，将这个worksapceWidget添加到你想要添加的位置上就ok</span></span><br><span class="line">workspaceWidget = <span class="built_in">static_cast</span>&lt;QOpenGLWidget*&gt;(&amp;(*(bBoxEdit-&gt;pWidget))); </span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/05/31/orbSlam3Complie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/31/orbSlam3Complie/" class="post-title-link" itemprop="url">orbSlam3Complie</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-31 18:53:31" itemprop="dateCreated datePublished" datetime="2021-05-31T18:53:31+08:00">2021-05-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-编译orb-slam"><a href="#1-编译orb-slam" class="headerlink" title="1 编译orb_slam"></a>1 编译orb_slam</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/UZ-SLAMLab/ORB_SLAM3.git ORB_SLAM3</span><br></pre></td></tr></table></figure>
<p>建议编译前，先看一下该项目上的一个pull request:(使用原来项目问题过多, 遇到的每一个问题在第4节都会详细描述，于是使用如下的一个PR)<br><a target="_blank" rel="noopener" href="https://github.com/UZ-SLAMLab/ORB_SLAM3/pull/53">https://github.com/UZ-SLAMLab/ORB_SLAM3/pull/53</a><br>推荐使用vs2015生成器;</p>
<h3 id="2-编译"><a href="#2-编译" class="headerlink" title="2 编译"></a>2 编译</h3><h4 id="2-1-DBoW2-编译-如果使用pr，本步骤可以不看，2-3的orbslam3也对所有cmakelist-txt的修改做了说明"><a href="#2-1-DBoW2-编译-如果使用pr，本步骤可以不看，2-3的orbslam3也对所有cmakelist-txt的修改做了说明" class="headerlink" title="2.1 DBoW2 编译(如果使用pr，本步骤可以不看，2.3的orbslam3也对所有cmakelist.txt的修改做了说明)"></a>2.1 DBoW2 编译(如果使用pr，本步骤可以不看，2.3的orbslam3也对所有cmakelist.txt的修改做了说明)</h4><p>主要是需要添加oepncv和boost的依赖</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PS F:\prjs\ORB_SLAM3&gt; git diff</span><br><span class="line"><span class="comment">diff --git a/Thirdparty/DBoW2/CMakeLists.txt b/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="comment">index c561724..2368c23 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="meta">@@ -32,9 +32,22 @@</span> if(NOT OpenCV_FOUND)</span><br><span class="line">    endif()</span><br><span class="line"> endif()</span><br><span class="line"></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+set(Boost_USE_STATIC_LIBS ON)</span></span><br><span class="line"><span class="addition">+add_definitions(&quot;-DBOOST_ALL_NO_LIB=1&quot;)</span></span><br><span class="line"><span class="addition">+find_package(Boost REQUIRED COMPONENTS</span></span><br><span class="line"><span class="addition">+             serialization)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> set(LIBRARY_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/lib)</span><br><span class="line"></span><br><span class="line"><span class="deletion">-include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span></span><br><span class="line"><span class="addition">+include_directories($&#123;OpenCV_INCLUDE_DIRS&#125; $&#123;BOOST_INCLUDEDIR&#125;)</span></span><br><span class="line"><span class="addition">+link_directories($&#123;Boost_LIBRARY_DIRS&#125;)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+message(&quot;lib is: &quot; $&#123;Boost_SERIALIZATION_LIBRARY&#125;)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> add_library(DBoW2 SHARED $&#123;SRCS_DBOW2&#125; $&#123;SRCS_DUTILS&#125;)</span><br><span class="line"><span class="deletion">-target_link_libraries(DBoW2 $&#123;OpenCV_LIBS&#125;)</span></span><br><span class="line"><span class="addition">+target_link_libraries(DBoW2 </span></span><br><span class="line"><span class="addition">+    $&#123;OpenCV_LIBS&#125;    </span></span><br><span class="line"><span class="addition">+    $&#123;Boost_SERIALIZATION_LIBRARY&#125;</span></span><br><span class="line"><span class="addition">+)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/Thirdparty/DBoW2/DBoW2/FORB.cpp b/Thirdparty/DBoW2/DBoW2/FORB.cpp</span></span><br><span class="line"><span class="comment">index 1f1990c..80bf473 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/DBoW2/DBoW2/FORB.cpp</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/DBoW2/DBoW2/FORB.cpp</span></span><br><span class="line"><span class="meta">@@ -13,7 +13,7 @@</span></span><br><span class="line"> #include &lt;vector&gt;</span><br><span class="line"> #include &lt;string&gt;</span><br><span class="line"> #include &lt;sstream&gt;</span><br><span class="line"><span class="deletion">-#include &lt;stdint-gcc.h&gt;</span></span><br><span class="line"><span class="addition">+#include &lt;stdint.h&gt;</span></span><br><span class="line"></span><br><span class="line"> #include &quot;FORB.h&quot;</span><br></pre></td></tr></table></figure>
<p>如果指定了vs2019，然后又用vs2015编译的库，就需要用如下的最后一个参数去掉boost的autolink;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake .. \</span><br><span class="line">-G <span class="string">&quot;Visual Studio 16&quot;</span> \</span><br><span class="line">-DCMAKE_BUILDY_TYPE=Release \</span><br><span class="line">-DOpenCV_DIR=<span class="string">&quot;F:/BASE_ENV/forOpenMVS/opencv/build&quot;</span> \</span><br><span class="line">-DBOOST_ROOT=<span class="string">&quot;F:/BASE_ENV/forOpenMVS/boost_1_73_0_v140&quot;</span> \</span><br><span class="line">-DBOOST_INCLUDEDIR=<span class="string">&quot;F:/BASE_ENV/forOpenMVS/boost_1_73_0_v140&quot;</span> \</span><br><span class="line">-DBOOST_LIBRARYDIR=<span class="string">&quot;F:/BASE_ENV/forOpenMVS/boost_1_73_0_v140&quot;</span> \</span><br><span class="line">-DBOOST_ALL_NO_LIB=1 \     <span class="comment"># 避免boost的autolink，autolink会要求vs版本和boost版本一致</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-g2o"><a href="#2-2-g2o" class="headerlink" title="2.2 g2o"></a>2.2 g2o</h3><p>项目-&gt;属性-&gt;c++-&gt;预处器宏定义-&gt;添加： WINDOWS，否则会出现vasprintf找不到定义。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ../../g2o</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Configuring and building Thirdparty/g2o ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake .. \</span><br><span class="line">-G <span class="string">&quot;Visual Studio 14&quot;</span> \</span><br><span class="line">-DCMAKE_BUILDY_TYPE=Release \</span><br><span class="line">-DEIGEN3_INCLUDE_DIR=<span class="string">&quot;F:\BASE_ENV\forOpenMVS\eigen&quot;</span> \</span><br><span class="line">-DBOOST_ALL_NO_LIB=1 \</span><br></pre></td></tr></table></figure>

<h3 id="2-3-orbslam3"><a href="#2-3-orbslam3" class="headerlink" title="2.3 orbslam3"></a>2.3 orbslam3</h3><h4 id="2-3-0-首先按照下面的diff修改所有的internal-axpy和internal-atxpy"><a href="#2-3-0-首先按照下面的diff修改所有的internal-axpy和internal-atxpy" class="headerlink" title="2.3.0 首先按照下面的diff修改所有的internal::axpy和internal::atxpy"></a>2.3.0 首先按照下面的diff修改所有的internal::axpy和internal::atxpy</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">// add these marcos to fix:  </span></span><br><span class="line">+<span class="comment">// 1&gt;f:\prjs\orb_slam3\thirdparty\g2o\g2o\core\sparse_block_matrix.hpp(277): fatal error C1001: 编译器中发生内部错误。</span></span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(yoff) += (A) * (x).segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(yoff) += (A).transpose() * (x).segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">   <span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-249</span>,<span class="number">7</span> +<span class="number">256</span>,<span class="number">8</span> @@ <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">         <span class="type">const</span> <span class="keyword">typename</span> SparseBlockMatrix&lt;MatrixType&gt;::SparseMatrixBlock* a=it-&gt;second;</span><br><span class="line">         <span class="type">int</span> destOffset = it-&gt;first ? _rowBlockIndices[it-&gt;first - <span class="number">1</span>] : <span class="number">0</span>;</span><br><span class="line">         <span class="comment">// destVec += *a * srcVec (according to the sub-vector parts)</span></span><br><span class="line">-        internal::<span class="built_in">axpy</span>(*a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">+        <span class="comment">// internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">+        _AXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">@@ <span class="number">-274</span>,<span class="number">9</span> +<span class="number">282</span>,<span class="number">12</span> @@ <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">         <span class="keyword">if</span> (destOffset &gt; srcOffset) <span class="comment">// only upper triangle</span></span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">         <span class="comment">// destVec += *a * srcVec (according to the sub-vector parts)</span></span><br><span class="line">-        internal::<span class="built_in">axpy</span>(*a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">-        <span class="keyword">if</span> (destOffset &lt; srcOffset)</span><br><span class="line">-          internal::<span class="built_in">atxpy</span>(*a, srcVec, destOffset, destVec, srcOffset);</span><br><span class="line">+        <span class="comment">// internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">+        _AXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">+        <span class="keyword">if</span> (destOffset &lt; srcOffset) &#123;</span><br><span class="line">+          <span class="comment">// internal::atxpy(*a, srcVec, destOffset, destVec, srcOffset);</span></span><br><span class="line">+          _ATXPY(MatrixType, *a, srcVec, destOffset, destVec, srcOffset);</span><br><span class="line">+        &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">@@ <span class="number">-305</span>,<span class="number">7</span> +<span class="number">316</span>,<span class="number">8</span> @@ <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">         <span class="type">const</span> <span class="keyword">typename</span> SparseBlockMatrix&lt;MatrixType&gt;::SparseMatrixBlock* a=it-&gt;second;</span><br><span class="line">         <span class="type">int</span> srcOffset = <span class="built_in">rowBaseOfBlock</span>(it-&gt;first);</span><br><span class="line">         <span class="comment">// destVec += *a.transpose() * srcVec (according to the sub-vector parts)</span></span><br><span class="line">-        internal::<span class="built_in">atxpy</span>(*a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">+        <span class="comment">// internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">+	    _ATXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">diff --git a/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h b/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span><br><span class="line">index <span class="number">36</span>ddfe6.<span class="number">.91832</span>cd <span class="number">100644</span></span><br><span class="line">--- a/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span><br><span class="line">+++ b/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span><br><span class="line">@@ <span class="number">-24</span>,<span class="number">6</span> +<span class="number">24</span>,<span class="number">9</span> @@</span><br><span class="line"> <span class="comment">// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span></span><br><span class="line"> <span class="comment">// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"> </span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(yoff) += (A) * (x).segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(yoff) += (A).transpose() * (x).segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+</span><br><span class="line"> <span class="meta">#<span class="keyword">ifndef</span> G2O_SPARSE_BLOCK_MATRIX_CCS_H</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> G2O_SPARSE_BLOCK_MATRIX_CCS_H</span></span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-122</span>,<span class="number">7</span> +<span class="number">125</span>,<span class="number">8</span> @@ <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">             <span class="type">const</span> SparseMatrixBlock* a = it-&gt;block;</span><br><span class="line">             <span class="type">int</span> srcOffset = <span class="built_in">rowBaseOfBlock</span>(it-&gt;row);</span><br><span class="line">             <span class="comment">// destVec += *a.transpose() * srcVec (according to the sub-vector parts)</span></span><br><span class="line">-            internal::<span class="built_in">atxpy</span>(*a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">+            <span class="comment">// internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">+            _ATXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">diff --git a/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h b/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span><br><span class="line">index <span class="number">7b</span>13b9f.<span class="number">.8605</span>a5f <span class="number">100644</span></span><br><span class="line">--- a/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span><br><span class="line">+++ b/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span><br><span class="line">@@ <span class="number">-24</span>,<span class="number">6</span> +<span class="number">24</span>,<span class="number">9</span> @@</span><br><span class="line"> <span class="comment">// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span></span><br><span class="line"> <span class="comment">// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"> </span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(yoff) += (A) * (x).segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment<span class="string">&lt;MatrixType::ColsAtCompileTime&gt;</span>(yoff) += (A).transpose() * (x).segment<span class="string">&lt;MatrixType::RowsAtCompileTime&gt;</span>(xoff)</span></span><br><span class="line">+</span><br><span class="line"> <span class="meta">#<span class="keyword">ifndef</span> G2O_SPARSE_BLOCK_MATRIX_DIAGONAL_H</span></span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> G2O_SPARSE_BLOCK_MATRIX_DIAGONAL_H</span></span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-94</span>,<span class="number">7</span> +<span class="number">97</span>,<span class="number">8</span> @@ <span class="keyword">namespace</span> g2o &#123;</span><br><span class="line">           <span class="type">int</span> srcOffset = destOffset;</span><br><span class="line">           <span class="type">const</span> SparseMatrixBlock&amp; A = _diagonal[i];</span><br><span class="line">           <span class="comment">// destVec += *A.transpose() * srcVec (according to the sub-vector parts)</span></span><br><span class="line">-          internal::<span class="built_in">axpy</span>(A, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">+          <span class="comment">// internal::axpy(A, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">+          _AXPY(MatrixType, A, srcVec, srcOffset, destVec, destOffset);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果你是自己在orbslam3直接编译的话，请参考: <a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o/issues/91">https://github.com/RainerKuemmerle/g2o/issues/91</a></p>
<h4 id="2-3-1-找不到unistd-h"><a href="#2-3-1-找不到unistd-h" class="headerlink" title="2.3.1 找不到unistd.h"></a>2.3.1 找不到unistd.h</h4><p>首先：unistd.h需要修改调，主要是为了使用usleep，该函数使用如下代码替换：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">```cpp</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">usleep</span><span class="params">(__int64 usec)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    HANDLE timer; </span><br><span class="line">    LARGE_INTEGER ft; </span><br><span class="line"></span><br><span class="line">    ft.QuadPart = -(<span class="number">10</span>*usec); <span class="comment">// Convert to 100 nanosecond interval, negative value indicates relative time</span></span><br><span class="line"></span><br><span class="line">    timer = <span class="built_in">CreateWaitableTimer</span>(<span class="literal">NULL</span>, TRUE, <span class="literal">NULL</span>); </span><br><span class="line">    <span class="built_in">SetWaitableTimer</span>(timer, &amp;ft, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>); </span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(timer, INFINITE); </span><br><span class="line">    <span class="built_in">CloseHandle</span>(timer); </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>或者如下一行能搞定：<strong>推荐这个方法</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ttrack &lt; T) &#123;</span><br><span class="line">    <span class="type">long</span> usec = <span class="built_in">static_cast</span>&lt;<span class="type">long</span>&gt;((T - ttrack) * <span class="number">1e6</span>);</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(usec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="2-3-2-使用cmake-gui开始编译"><a href="#2-3-2-使用cmake-gui开始编译" class="headerlink" title="2.3.2 使用cmake-gui开始编译"></a>2.3.2 使用cmake-gui开始编译</h4><p>cmake-gui配置：<br>opencv，boost，需要修改cmakelist.txt:<br>添加如下定义：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DBOOST_ALL_NO_LIB=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>如下是我对cmakeList.txt做出的修改。</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/CMakeLists.txt b/CMakeLists.txt</span></span><br><span class="line"><span class="comment">index 70d03fe..79b32e7 100644</span></span><br><span class="line"><span class="comment">--- a/CMakeLists.txt</span></span><br><span class="line"><span class="comment">+++ b/CMakeLists.txt</span></span><br><span class="line"><span class="meta">@@ -34,6 +34,7 @@</span> if (CMAKE_CXX_COMPILER_ID MATCHES &quot;MSVC&quot;)</span><br><span class="line">   #set(CMAKE_CXX_FLAGS_DEBUG &quot;$&#123;CMAKE_CXX_FLAGS_DEBUG&#125; /MTd&quot;)</span><br><span class="line"> endif()</span><br><span class="line"> </span><br><span class="line"><span class="addition">+add_definitions(&quot;-DBOOST_ALL_NO_LIB=1&quot;)</span></span><br><span class="line"> </span><br><span class="line"> LIST(APPEND CMAKE_MODULE_PATH $&#123;PROJECT_SOURCE_DIR&#125;/cmake_modules)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -46,13 +47,15 @@</span> if(NOT OpenCV_FOUND)</span><br><span class="line"> endif()</span><br><span class="line"> MESSAGE(STATUS &quot;OpenCV VERSION: $&#123;OpenCV_VERSION&#125;&quot;)</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-find_package(Eigen3 3.1.0 REQUIRED)</span></span><br><span class="line"><span class="addition">+# find_package(Eigen3 REQUIRED)</span></span><br><span class="line"><span class="addition">+set(EIGEN3_INCLUDE_DIR &quot;F:/BASE_ENV/forOpenMVS/eigen&quot;)</span></span><br><span class="line"><span class="addition">+MESSAGE(&quot;eigen &amp; boost inlcude dir is: @@@@@@&quot; $&#123;EIGEN3_INCLUDE_DIRS&#125;) </span></span><br><span class="line"> </span><br><span class="line"> find_package(Pangolin REQUIRED)</span><br><span class="line"> find_package(realsense2)</span><br><span class="line"> </span><br><span class="line"> find_package(Boost REQUIRED COMPONENTS serialization)</span><br><span class="line"><span class="deletion">-MESSAGE(STATUS &quot;Boost_LIBRARIES: $&#123;Boost_LIBRARIES&#125;&quot;)</span></span><br><span class="line"><span class="addition">+MESSAGE(STATUS &quot;cxy@@@@@@@@@@ Boost_INCLUDE_DIRS &amp; Boost_LIBRARIES: $&#123;Boost_INCLUDE_DIRS&#125; $&#123;Boost_LIBRARIES&#125;&quot;)</span></span><br><span class="line"> </span><br><span class="line"> set(OPENSSL_USE_STATIC_LIBS TRUE)</span><br><span class="line"> find_package(OpenSSL REQUIRED) # for crypto library</span><br><span class="line"><span class="meta">@@ -65,6 +68,7 @@</span> include_directories(</span><br><span class="line">   $&#123;EIGEN3_INCLUDE_DIR&#125;</span><br><span class="line">   $&#123;Pangolin_INCLUDE_DIRS&#125;</span><br><span class="line">   $&#123;OPENSSL_INCLUDE_DIR&#125;</span><br><span class="line"><span class="addition">+  $&#123;Boost_INCLUDE_DIRS&#125;</span></span><br><span class="line"> )</span><br><span class="line"> </span><br><span class="line"> set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY $&#123;PROJECT_SOURCE_DIR&#125;/lib)</span><br><span class="line"><span class="comment">diff --git a/Thirdparty/DBoW2/CMakeLists.txt b/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="comment">index bf987be..e527175 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/DBoW2/CMakeLists.txt</span></span><br><span class="line"><span class="meta">@@ -51,10 +51,16 @@</span> if(NOT OpenCV_FOUND)</span><br><span class="line">   endif()</span><br><span class="line"> endif()</span><br><span class="line"> MESSAGE(STATUS &quot;OpenCV VERSION: $&#123;OpenCV_VERSION&#125;&quot;)</span><br><span class="line"><span class="deletion">-include_directories($&#123;OpenCV_INCLUDE_DIRS&#125;)</span></span><br><span class="line"><span class="deletion">-target_link_libraries(DBoW2 $&#123;OpenCV_LIBS&#125;)</span></span><br><span class="line"> </span><br><span class="line"> # add Boost</span><br><span class="line"><span class="deletion">-find_package(Boost REQUIRED COMPONENTS serialization)</span></span><br><span class="line"><span class="deletion">-message(STATUS &quot;Boost_LIBRARIES: $&#123;Boost_LIBRARIES&#125;&quot;)</span></span><br><span class="line"><span class="deletion">-target_link_libraries(DBoW2 $&#123;Boost_LIBRARIES&#125;)</span></span><br><span class="line"><span class="addition">+set(Boost_USE_STATIC_LIBS ON)</span></span><br><span class="line"><span class="addition">+add_definitions(&quot;-DBOOST_ALL_NO_LIB=1&quot;)</span></span><br><span class="line"><span class="addition">+find_package(Boost REQUIRED COMPONENTS </span></span><br><span class="line"><span class="addition">+                  serialization)</span></span><br><span class="line"><span class="addition">+message(STATUS &quot;cxy@@@@@@@@ Boost_INCLUDE_DIRS &amp; libs: $&#123;Boost_INCLUDE_DIRS&#125; &gt;&gt;&gt;&gt; $&#123;Boost_LIBRARIES&#125;&quot;)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+include_directories($&#123;OpenCV_INCLUDE_DIRS&#125; $&#123;BOOST_INCLUDEDIR&#125;)</span></span><br><span class="line"><span class="addition">+target_link_libraries(DBoW2 </span></span><br><span class="line"><span class="addition">+  $&#123;OpenCV_LIBS&#125; </span></span><br><span class="line"><span class="addition">+  $&#123;Boost_LIBRARIES&#125;</span></span><br><span class="line"><span class="addition">+)</span></span><br><span class="line"><span class="comment">diff --git a/Thirdparty/g2o/g2o/core/sparse_block_matrix.hpp b/Thirdparty/g2o/g2o/core/sparse_block_matrix.hpp</span></span><br><span class="line"><span class="comment">index 8dfa99c..80e4fa8 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/g2o/g2o/core/sparse_block_matrix.hpp</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/g2o/g2o/core/sparse_block_matrix.hpp</span></span><br><span class="line"><span class="meta">@@ -24,6 +24,13 @@</span></span><br><span class="line"> // NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span><br><span class="line"> // SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br><span class="line"> </span><br><span class="line"><span class="addition">+// add these marcos to fix:  </span></span><br><span class="line"><span class="addition">+// 1&gt;f:\prjs\orb_slam3\thirdparty\g2o\g2o\core\sparse_block_matrix.hpp(277): fatal error C1001: 编译器中发生内部错误。</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::RowsAtCompileTime&gt;(yoff) += (A) * (x).segment&lt;MatrixType::ColsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+#define _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::ColsAtCompileTime&gt;(yoff) += (A).transpose() * (x).segment&lt;MatrixType::RowsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> namespace g2o &#123;</span><br><span class="line">   using namespace Eigen;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -249,7 +256,8 @@</span> namespace g2o &#123;</span><br><span class="line">         const typename SparseBlockMatrix&lt;MatrixType&gt;::SparseMatrixBlock* a=it-&gt;second;</span><br><span class="line">         int destOffset = it-&gt;first ? _rowBlockIndices[it-&gt;first - 1] : 0;</span><br><span class="line">         // destVec += *a * srcVec (according to the sub-vector parts)</span><br><span class="line"><span class="deletion">-        internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+        // internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+        _AXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -274,9 +282,12 @@</span> namespace g2o &#123;</span><br><span class="line">         if (destOffset &gt; srcOffset) // only upper triangle</span><br><span class="line">           break;</span><br><span class="line">         // destVec += *a * srcVec (according to the sub-vector parts)</span><br><span class="line"><span class="deletion">-        internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="deletion">-        if (destOffset &lt; srcOffset)</span></span><br><span class="line"><span class="deletion">-          internal::atxpy(*a, srcVec, destOffset, destVec, srcOffset);</span></span><br><span class="line"><span class="addition">+        // internal::axpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+        _AXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+        if (destOffset &lt; srcOffset) &#123;</span></span><br><span class="line"><span class="addition">+          // internal::atxpy(*a, srcVec, destOffset, destVec, srcOffset);</span></span><br><span class="line"><span class="addition">+          _ATXPY(MatrixType, *a, srcVec, destOffset, destVec, srcOffset);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -305,7 +316,8 @@</span> namespace g2o &#123;</span><br><span class="line">         const typename SparseBlockMatrix&lt;MatrixType&gt;::SparseMatrixBlock* a=it-&gt;second;</span><br><span class="line">         int srcOffset = rowBaseOfBlock(it-&gt;first);</span><br><span class="line">         // destVec += *a.transpose() * srcVec (according to the sub-vector parts)</span><br><span class="line"><span class="deletion">-        internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+        // internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+	    _ATXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line"><span class="comment">diff --git a/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h b/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span></span><br><span class="line"><span class="comment">index 36ddfe6..91832cd 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/g2o/g2o/core/sparse_block_matrix_ccs.h</span></span><br><span class="line"><span class="meta">@@ -24,6 +24,9 @@</span></span><br><span class="line"> // NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span><br><span class="line"> // SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#define _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::RowsAtCompileTime&gt;(yoff) += (A) * (x).segment&lt;MatrixType::ColsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+#define _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::ColsAtCompileTime&gt;(yoff) += (A).transpose() * (x).segment&lt;MatrixType::RowsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> #ifndef G2O_SPARSE_BLOCK_MATRIX_CCS_H</span><br><span class="line"> #define G2O_SPARSE_BLOCK_MATRIX_CCS_H</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -122,7 +125,8 @@</span> namespace g2o &#123;</span><br><span class="line">             const SparseMatrixBlock* a = it-&gt;block;</span><br><span class="line">             int srcOffset = rowBaseOfBlock(it-&gt;row);</span><br><span class="line">             // destVec += *a.transpose() * srcVec (according to the sub-vector parts)</span><br><span class="line"><span class="deletion">-            internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+            // internal::atxpy(*a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+            _ATXPY(MatrixType, *a, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">diff --git a/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h b/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span></span><br><span class="line"><span class="comment">index 7b13b9f..8605a5f 100644</span></span><br><span class="line"><span class="comment">--- a/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span></span><br><span class="line"><span class="comment">+++ b/Thirdparty/g2o/g2o/core/sparse_block_matrix_diagonal.h</span></span><br><span class="line"><span class="meta">@@ -24,6 +24,9 @@</span></span><br><span class="line"> // NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span><br><span class="line"> // SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br><span class="line"> </span><br><span class="line"><span class="addition">+#define _AXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::RowsAtCompileTime&gt;(yoff) += (A) * (x).segment&lt;MatrixType::ColsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+#define _ATXPY(MatrixType,A,x,xoff,y,yoff)y.segment&lt;MatrixType::ColsAtCompileTime&gt;(yoff) += (A).transpose() * (x).segment&lt;MatrixType::RowsAtCompileTime&gt;(xoff)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> #ifndef G2O_SPARSE_BLOCK_MATRIX_DIAGONAL_H</span><br><span class="line"> #define G2O_SPARSE_BLOCK_MATRIX_DIAGONAL_H</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -94,7 +97,8 @@</span> namespace g2o &#123;</span><br><span class="line">           int srcOffset = destOffset;</span><br><span class="line">           const SparseMatrixBlock&amp; A = _diagonal[i];</span><br><span class="line">           // destVec += *A.transpose() * srcVec (according to the sub-vector parts)</span><br><span class="line"><span class="deletion">-          internal::axpy(A, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+          // internal::axpy(A, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line"><span class="addition">+          _AXPY(MatrixType, A, srcVec, srcOffset, destVec, destOffset);</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-编译成功显示："><a href="#3-编译成功显示：" class="headerlink" title="3 编译成功显示："></a>3 编译成功显示：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1&gt;F:\prjs\ORB_SLAM3\Thirdparty\Pangolin\include\pangolin/gl/gldraw.h(109,1): warning C4267: “参数”: 从“size_t”转换到“GLint”，可能丢失数据</span><br><span class="line">1&gt;  正在创建库 F:/prjs/ORB_SLAM3_Fix/ORB_SLAM3/lib/mono_kitti.lib 和对象 F:/prjs/ORB_SLAM3_Fix/ORB_SLAM3/lib/mono_kitti.exp</span><br><span class="line">1&gt;mono_kitti.vcxproj -&gt; F:\prjs\ORB_SLAM3_Fix\ORB_SLAM3\bin\mono_kitti.exe</span><br><span class="line">1&gt;已完成生成项目“mono_kitti.vcxproj”的操作。</span><br><span class="line">========== 生成: 成功 1 个，失败 0 个，最新 4 个，跳过 0 个 ==========</span><br></pre></td></tr></table></figure>
<p>  如下是一个调用gif：</p>
<ul>
<li>1 下载数据：<a target="_blank" rel="noopener" href="http://robotics.ethz.ch/~asl-datasets/ijrr_euroc_mav_dataset/machine_hall/MH_01_easy/MH_01_easy.zip">http://robotics.ethz.ch/~asl-datasets/ijrr_euroc_mav_dataset/machine_hall/MH_01_easy/MH_01_easy.zip</a></li>
<li>2 进入：ORB_SLAM3/Examples，执行脚本euroc_eval_examles.sh中的一行，将其中的一行（比如第7行）改成你需要的格式，然后拿出来执行：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Monocular/mono_euroc ../Vocabulary/ORBvoc.txt ./Monocular/EuRoC.yaml ./EuRoc_Data/MH_01_easy/ ./Monocular/EuRoC_TimeStamps/MH01.txt result/Resdataset-MH01_mono</span><br></pre></td></tr></table></figure>
执行结果：<br><img src="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/orbslam3.5qu5qjc1jvw0.gif" alt="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/orbslam3.5qu5qjc1jvw0.gif"></li>
</ul>
<h3 id="4-可能遇到的问题"><a href="#4-可能遇到的问题" class="headerlink" title="4 可能遇到的问题"></a>4 可能遇到的问题</h3><h4 id="4-1-g2o-gt-vasprint-找不到标识符"><a href="#4-1-g2o-gt-vasprint-找不到标识符" class="headerlink" title="4.1 g2o -&gt; vasprint 找不到标识符"></a>4.1 g2o -&gt; vasprint 找不到标识符</h4><p>到它的声明处，就会发现，它的声明和定义均位于非活动预处理器块中，被宏定义WINDOWS关闭了。所以添加对应的宏定义即可：右键项目-&gt;属性-&gt;C++-&gt;预处理器-&gt;预处理器定义，为其添加一个变量，WINDOWS，保存设定之后，这个错误也就消失了。<br>以上过程也可以在cmakelist.txt中添加： ADD_DEFINITIONS(-DWINDOWS)</p>
<h4 id="4-2-orb-slam3-gt-cl-exe-has-no-C-11-support-Please-use-a-different-C-compiler"><a href="#4-2-orb-slam3-gt-cl-exe-has-no-C-11-support-Please-use-a-different-C-compiler" class="headerlink" title="4.2 orb-slam3 -&gt; cl.exe has no C++11 support.  Please use a different C++ compiler."></a>4.2 orb-slam3 -&gt; cl.exe has no C++11 support.  Please use a different C++ compiler.</h4><p>因为cmakelist对于cl的c++11的支持方式需要如下编写：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">--- a/CMakeLists.txt</span><br><span class="line">+++ b/CMakeLists.txt</span><br><span class="line">@@ -<span class="number">17</span>,<span class="number">19</span> +<span class="number">17</span>,<span class="number">20</span> @@ <span class="keyword">set</span>(CMAKE_CXX_FLAGS_RELEASE <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS_RELEASE&#125; -march=native&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Check C++11 or C++0x support</span></span><br><span class="line"> <span class="keyword">include</span>(CheckCXXCompilerFlag)</span><br><span class="line">-CHECK_CXX_COMPILER_FLAG(<span class="string">&quot;-std=c++11&quot;</span> COMPILER_SUPPORTS_CXX11)</span><br><span class="line">-CHECK_CXX_COMPILER_FLAG(<span class="string">&quot;-std=c++0x&quot;</span> COMPILER_SUPPORTS_CXX0X)</span><br><span class="line">-<span class="keyword">if</span>(COMPILER_SUPPORTS_CXX11)</span><br><span class="line">-   <span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11&quot;</span>)</span><br><span class="line">-   <span class="keyword">add_definitions</span>(-DCOMPILEDWITHC11)</span><br><span class="line">-   <span class="keyword">message</span>(STATUS <span class="string">&quot;Using flag -std=c++11.&quot;</span>)</span><br><span class="line">-<span class="keyword">elseif</span>(COMPILER_SUPPORTS_CXX0X)</span><br><span class="line">-   <span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++0x&quot;</span>)</span><br><span class="line">-   <span class="keyword">add_definitions</span>(-DCOMPILEDWITHC0X)</span><br><span class="line">-   <span class="keyword">message</span>(STATUS <span class="string">&quot;Using flag -std=c++0x.&quot;</span>)</span><br><span class="line">-<span class="keyword">else</span>()</span><br><span class="line">-   <span class="keyword">message</span>(FATAL_ERROR <span class="string">&quot;The compiler $&#123;CMAKE_CXX_COMPILER&#125; has no C++11 support. Please use a different C++ compiler.&quot;</span>)</span><br><span class="line">-<span class="keyword">endif</span>()</span><br><span class="line">+<span class="keyword">set</span> (CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line">+<span class="comment"># CHECK_CXX_COMPILER_FLAG(&quot;-std=c++11&quot; COMPILER_SUPPORTS_CXX11)</span></span><br><span class="line">+<span class="comment"># CHECK_CXX_COMPILER_FLAG(&quot;-std=c++0x&quot; COMPILER_SUPPORTS_CXX0X)</span></span><br><span class="line">+<span class="comment"># if(COMPILER_SUPPORTS_CXX11)</span></span><br><span class="line">+<span class="comment">#    set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11&quot;)</span></span><br><span class="line">+<span class="comment">#    add_definitions(-DCOMPILEDWITHC11)</span></span><br><span class="line">+<span class="comment">#    message(STATUS &quot;Using flag -std=c++11.&quot;)</span></span><br><span class="line">+<span class="comment"># elseif(COMPILER_SUPPORTS_CXX0X)</span></span><br><span class="line">+<span class="comment">#    set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++0x&quot;)</span></span><br><span class="line">+<span class="comment">#    add_definitions(-DCOMPILEDWITHC0X)</span></span><br><span class="line">+<span class="comment">#    message(STATUS &quot;Using flag -std=c++0x.&quot;)</span></span><br><span class="line">+<span class="comment"># else()</span></span><br><span class="line">+<span class="comment">#    message(FATAL_ERROR &quot;The compiler $&#123;CMAKE_CXX_COMPILER&#125; has no C++11 support. Please use a different C++ compiler.&quot;)</span></span><br><span class="line">+<span class="comment"># endif()</span></span><br></pre></td></tr></table></figure>

<h4 id="4-3-stdio-gcc-h找不到"><a href="#4-3-stdio-gcc-h找不到" class="headerlink" title="4.3 stdio-gcc.h找不到"></a>4.3 stdio-gcc.h找不到</h4><p>将其改为stdio.h即可</p>
<h4 id="4-4-Failed-to-run-MSBuild-command-C-Program-Files-x86-MSBuild-14-0-bin-MSBuild-exe"><a href="#4-4-Failed-to-run-MSBuild-command-C-Program-Files-x86-MSBuild-14-0-bin-MSBuild-exe" class="headerlink" title="4.4 Failed to run MSBuild command:      C:/Program Files (x86)/MSBuild/14.0/bin/MSBuild.exe"></a>4.4 Failed to run MSBuild command:      C:/Program Files (x86)/MSBuild/14.0/bin/MSBuild.exe</h4><p>将上述的MSBuild.exe添加到里面，然后<a target="_blank" rel="noopener" href="https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/">https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/</a><br>里面找到win8.1的sdk，安装即可。</p>
<h4 id="4-5-fata-error-compiler-internal-error-on-msc1-cpp-1xxx编译器内部错误"><a href="#4-5-fata-error-compiler-internal-error-on-msc1-cpp-1xxx编译器内部错误" class="headerlink" title="4.5 fata_error: compiler internal error on msc1.cpp:1xxx编译器内部错误"></a>4.5 fata_error: compiler internal error on msc1.cpp:1xxx编译器内部错误</h4><p>和g2o/core/matrix_operation.h的代码有关系，参考如下修改：<br><a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o/issues/91">https://github.com/RainerKuemmerle/g2o/issues/91</a><br><a target="_blank" rel="noopener" href="https://github.com/UZ-SLAMLab/ORB_SLAM3/pull/53">https://github.com/UZ-SLAMLab/ORB_SLAM3/pull/53</a></p>
<h4 id="4-6-std-max找不到定义"><a href="#4-6-std-max找不到定义" class="headerlink" title="4.6 std::max找不到定义"></a>4.6 std::max找不到定义</h4><p>添加： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;algorithm&gt;</span><br></pre></td></tr></table></figure>


<h4 id="4-7-找不到openssl-md5-h"><a href="#4-7-找不到openssl-md5-h" class="headerlink" title="4.7 找不到openssl/md5.h"></a>4.7 找不到openssl/md5.h</h4><p>可以尝试安装strawberry-perl，里面有oepnssl的库，然后下载openssl的源码获得其include。<br>这里也有openssl编译好的链接库： <a target="_blank" rel="noopener" href="https://indy.fulgan.com/SSL/LinkLibs/">https://indy.fulgan.com/SSL/LinkLibs/</a><br>我的下载地址为：<a target="_blank" rel="noopener" href="https://indy.fulgan.com/SSL/LinkLibs/openssl-1.0.2g-x64_86-win64_LinkLibs.zip">https://indy.fulgan.com/SSL/LinkLibs/openssl-1.0.2g-x64_86-win64_LinkLibs.zip</a></p>
<p>配置完成后比如一些openssl的依赖就需要手动添加了：<br>F:\BASE_ENV\openSSL\openssl\include<br>F:\BASE_ENV\openSSL\openssl\lib\ssleay32.lib<br>F:\BASE_ENV\openSSL\openssl\lib\libeay32.lib</p>
<h4 id="4-8-link2005-error-将所有项目-gt-属性-gt-c-gt-代码生成-gt-MD改成MT"><a href="#4-8-link2005-error-将所有项目-gt-属性-gt-c-gt-代码生成-gt-MD改成MT" class="headerlink" title="4.8 link2005 error 将所有项目-&gt;属性-&gt;c++-&gt;代码生成-&gt;MD改成MT"></a>4.8 link2005 error 将所有项目-&gt;属性-&gt;c++-&gt;代码生成-&gt;MD改成MT</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1&gt;msvcprt.lib(MSVCP140.dll) : error LNK2005: &quot;public: class std::basic_istream&lt;char,struct std::char_traits&lt;char&gt; &gt; &amp; __cdecl std::basic_istream&lt;char,struct std::char_traits&lt;char&gt; &gt;::operator&gt;&gt;(double &amp;)&quot; (??5?$basic_istream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@AEAN@Z) 已经在 pangolin.lib(widgets.obj) 中定义</span><br><span class="line">1&gt;msvcprt.lib(MSVCP140.dll) : error LNK2005: &quot;public: virtual __cdecl std::basic_iostream&lt;char,struct std::char_traits&lt;char&gt; &gt;::~basic_iostream&lt;char,struct std::char_traits&lt;char&gt; &gt;(void)&quot; (??1?$basic_iostream@DU?$char_traits@D@std@@@std@@UEAA@XZ) 已经在 ORB_SLAM3.lib(System.obj) 中定义</span><br><span class="line">1&gt;libcpmt.lib(locale0.obj) : error LNK2038: 检测到“RuntimeLibrary”的不匹配项: 值“MT_StaticRelease”不匹配值“MD_DynamicRelease”(stereo_euroc.obj 中)</span><br><span class="line">1&gt;libcpmt.lib(locale0.obj) : error LNK2005: &quot;void __cdecl std::_Facet_Register(class std::_Facet_base *)&quot; (?_Facet_Register@std@@YAXPEAV_Facet_base@1@@Z) 已经在 msv</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-9-QT5找不到FindQT5-cmake"><a href="#4-9-QT5找不到FindQT5-cmake" class="headerlink" title="4.9 QT5找不到FindQT5.cmake"></a>4.9 QT5找不到FindQT5.cmake</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step1: 设置qt的安装位置</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_PREFIX_PATH <span class="string">&quot;/opt/Qt/5.12.3/gcc_64&quot;</span>) <span class="comment"># windows下应该是msvc2015 或者之后的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step2: 设置你需要的qt的库的dir</span></span><br><span class="line"><span class="keyword">set</span>(Qt5_DIR <span class="string">&quot;$&#123;CMAKE_PREFIX_PATH&#125;/lib/cmake/Qt5&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(Qt5Widgets_DIR <span class="string">&quot;$&#123;CMAKE_PREFIX_PATH&#125;/lib/cmake/Qt5Widgets&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(Qt5Network_DIR <span class="string">&quot;$&#123;CMAKE_PREFIX_PATH&#125;/lib/cmake/Qt5Network&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(Qt5LinguistTools_DIR <span class="string">&quot;$&#123;CMAKE_PREFIX_PATH&#125;/lib/cmake/Qt5LinguistTools&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(Qt5 COMPONENTS Widgets Network LinguistTools)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/05/29/groundVehicle/groundVehicle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/groundVehicle/groundVehicle/" class="post-title-link" itemprop="url">groundVehicle - cesium中实现贴地车辆</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-29 19:47:18" itemprop="dateCreated datePublished" datetime="2021-05-29T19:47:18+08:00">2021-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cesium/" itemprop="url" rel="index"><span itemprop="name">cesium</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cesium/webDev/" itemprop="url" rel="index"><span itemprop="name">webDev</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-实现要求"><a href="#1-实现要求" class="headerlink" title="1 实现要求"></a>1 实现要求</h2><ul>
<li>1 地面车辆按照规定的起点和终点运行</li>
<li>2 地面车辆必须贴地运动</li>
<li>3 地面车辆的必须有俯仰角的变化</li>
<li>4 循环播放，且车辆经过路径动态高亮，下一次循环清除高亮</li>
</ul>
<h2 id="2-实现效果"><a href="#2-实现效果" class="headerlink" title="2 实现效果"></a>2 实现效果</h2><p><img src="https://img-blog.csdnimg.cn/20210109190042313.gif#pic_center" alt="在这里插入图片描述"></p>
<h2 id="3-实现代码"><a href="#3-实现代码" class="headerlink" title="3 实现代码"></a>3 实现代码</h2><p>将如下代码替换到cesium的一个例子中即可：<a target="_blank" rel="noopener" href="https://sandcastle.cesium.com/index.html?src=Interpolation.html">https://sandcastle.cesium.com/index.html?src=Interpolation.html</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">var</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&quot;cesiumContainer&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">infoBox</span>: <span class="literal">false</span>, <span class="comment">//Disable InfoBox widget</span></span><br><span class="line">    <span class="attr">selectionIndicator</span>: <span class="literal">false</span>, <span class="comment">//Disable selection indicator</span></span><br><span class="line">    <span class="attr">shouldAnimate</span>: <span class="literal">true</span>, <span class="comment">// Enable animations</span></span><br><span class="line">    <span class="attr">terrainProvider</span>: <span class="title class_">Cesium</span>.<span class="title function_">createWorldTerrain</span>(),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Enable lighting based on the sun position</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">enableLighting</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Enable depth testing so things behind the terrain disappear.</span></span><br><span class="line">viewer.<span class="property">scene</span>.<span class="property">globe</span>.<span class="property">depthTestAgainstTerrain</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Set the random number seed for consistent results.</span></span><br><span class="line"><span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">setRandomNumberSeed</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> times = [</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&quot;2018-07-19T15:18:00Z&quot;</span>),</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">fromIso8601</span>(<span class="string">&quot;2018-07-19T15:24:00Z&quot;</span>)</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> stTime = times[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">let</span> endTime = times[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">var</span> start = stTime.<span class="title function_">clone</span>();</span><br><span class="line"><span class="keyword">var</span> stop = endTime.<span class="title function_">clone</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Make sure viewer is at the desired time.</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">startTime</span> = start.<span class="title function_">clone</span>();</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">stopTime</span> = stop.<span class="title function_">clone</span>();</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">currentTime</span> = start.<span class="title function_">clone</span>();</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">clockRange</span> = <span class="title class_">Cesium</span>.<span class="property">ClockRange</span>.<span class="property">LOOP_STOP</span>; <span class="comment">//Loop at the end</span></span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">multiplier</span> = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Set timeline to simulation bounds</span></span><br><span class="line">viewer.<span class="property">timeline</span>.<span class="title function_">zoomTo</span>(start, stop);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Generate a random circular pattern with varying heights.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">computeCirclularFlight</span>(<span class="params">lon, lat, radius</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> property = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= <span class="number">360</span>; i += <span class="number">45</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> radians = <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(i);</span><br><span class="line">        <span class="keyword">var</span> time = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(start, i, <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>());</span><br><span class="line">        <span class="keyword">var</span> position = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">            lon + radius * <span class="number">1.5</span> * <span class="title class_">Math</span>.<span class="title function_">cos</span>(radians),</span><br><span class="line">            lat + radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(radians),</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">nextRandomNumber</span>() * <span class="number">500</span> + <span class="number">1750</span></span><br><span class="line">        );</span><br><span class="line">        property.<span class="title function_">addSample</span>(time, position);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(time.<span class="title function_">toString</span>(), <span class="string">&quot; -&gt; &quot;</span>, position.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Also create a point for each sample we generate.</span></span><br><span class="line">        viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">            <span class="attr">position</span>: position,</span><br><span class="line">            <span class="attr">point</span>: &#123;</span><br><span class="line">                <span class="attr">pixelSize</span>: <span class="number">8</span>,</span><br><span class="line">                <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">TRANSPARENT</span>,</span><br><span class="line">                <span class="attr">outlineColor</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">                <span class="attr">outlineWidth</span>: <span class="number">3</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> property;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> positions = [</span><br><span class="line">    <span class="comment">// new Cartesian3(1216348.1632364073, -4736348.958775471, 4081284.5528982095),</span></span><br><span class="line">    <span class="comment">// new Cartesian3(1216369.1229444197, -4736377.467107148, 4081240.888485707)</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(</span><br><span class="line">        -<span class="number">2358138.847340281</span>,</span><br><span class="line">        -<span class="number">3744072.459541374</span>,</span><br><span class="line">        <span class="number">4581158.5714175375</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartesian3</span>(</span><br><span class="line">        -<span class="number">2357231.4925370603</span>,</span><br><span class="line">        -<span class="number">3745103.7886602185</span>,</span><br><span class="line">        <span class="number">4580702.9757762635</span></span><br><span class="line">    ),</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> stPos = positions[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">let</span> endPos = positions[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// sampled postion&#x27;s time resolution</span></span><br><span class="line"><span class="keyword">let</span> timeOfResolution = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// using sampled property to get sampled data</span></span><br><span class="line"><span class="keyword">let</span> oriSamples = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledProperty</span>(<span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>);</span><br><span class="line">oriSamples.<span class="title function_">addSamples</span>(times, positions);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get sampled data, ervery &quot;distanceOfResolution&quot; we take a sample</span></span><br><span class="line"><span class="keyword">let</span> geodesic = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">EllipsoidGeodesic</span>(</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(stPos),</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(endPos)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">let</span> lenInMeters = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(geodesic.<span class="property">surfaceDistance</span>); <span class="comment">// avoid overflow when take samples</span></span><br><span class="line"><span class="keyword">let</span> samplesNum = <span class="title class_">Math</span>.<span class="title function_">floor</span>(</span><br><span class="line">    <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(endTime, stTime) / timeOfResolution</span><br><span class="line">);</span><br><span class="line"><span class="comment">//let secondsInterval = Math.floor(Cesium.JulianDate.secondsDifference(endTime, stTime) / samplesNum);</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="string">&quot;len: &quot;</span>,</span><br><span class="line">    lenInMeters,</span><br><span class="line">    <span class="string">&quot;samplesNum&quot;</span>,</span><br><span class="line">    samplesNum,</span><br><span class="line">    <span class="string">&quot;secondsInterval&quot;</span>,</span><br><span class="line">    timeOfResolution</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get sampled data, ervery &quot;timeOfResolution&quot; passed, we take a sample</span></span><br><span class="line"><span class="keyword">let</span> sampledPositions = [];</span><br><span class="line"><span class="keyword">let</span> sampledTimes = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; samplesNum + <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> sampleTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(</span><br><span class="line">        stTime,</span><br><span class="line">        i * timeOfResolution,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">let</span> tmpPos = oriSamples.<span class="title function_">getValue</span>(sampleTime);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sampleTime.<span class="title function_">toString</span>(), <span class="string">&quot; -&gt; || -&gt; &quot;</span>, tmpPos.<span class="title function_">toString</span>());</span><br><span class="line">    sampledPositions.<span class="title function_">push</span>(<span class="title class_">Cesium</span>.<span class="property">Cartographic</span>.<span class="title function_">fromCartesian</span>(tmpPos));</span><br><span class="line">    sampledTimes.<span class="title function_">push</span>(sampleTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="title class_">Cesium</span>.<span class="title function_">sampleTerrainMostDetailed</span>(</span><br><span class="line">    viewer.<span class="property">terrainProvider</span>,</span><br><span class="line">    sampledPositions</span><br><span class="line">).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">        <span class="string">&quot;start adding!&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time and pos size: &quot;</span>,</span><br><span class="line">        sampledTimes.<span class="property">length</span>,</span><br><span class="line">        sampledPositions.<span class="property">length</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> carPositionProperty = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add positions which are clamped to ground to the carPositionProperty</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; samplesNum + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        carPositionProperty.<span class="title function_">addSample</span>(</span><br><span class="line">            sampledTimes[i],</span><br><span class="line">            <span class="comment">// new Cesium.Cartesian3.fromDegrees( // this way of changing pos is not right, all should be under WGS84</span></span><br><span class="line">            <span class="comment">// sampledPositions[i].longitude,</span></span><br><span class="line">            <span class="comment">// sampledPositions[i].latitude,</span></span><br><span class="line">            <span class="comment">// sampledPositions[i].height));</span></span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span>.<span class="title function_">cartographicToCartesian</span>(sampledPositions[i])</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// console.log(sampledTimes[i], &quot; -------&gt;&gt;&gt; &quot;, sampledPositions[i]);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// after the clamped to ground data computed, dynamically show the path</span></span><br><span class="line">    <span class="keyword">let</span> isConstant = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> curSegmentNo = <span class="number">0</span>; <span class="comment">// the polyLine are divided into samplesNum&#x27;s segements</span></span><br><span class="line">    <span class="keyword">let</span> lastSegementNo = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> p2 = <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span>.<span class="title function_">cartographicToCartesian</span>(sampledPositions[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">let</span> curPolyline = [stPos]; <span class="comment">// represent the polyline</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init 2 points are: &quot;</span>, stPos.<span class="title function_">toString</span>(), <span class="string">&quot; &quot;</span>, p2.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="comment">//let timeNow = Cesium.JulianDate.now().clone();</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;starting add entity&quot;</span>);</span><br><span class="line">    viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">        <span class="attr">polyline</span>: &#123;</span><br><span class="line">            <span class="comment">// This callback updates positions each frame.</span></span><br><span class="line">            <span class="comment">// Ellipsoid.WGS84.cartographicArrayToCartesianArray(sampledPositions),</span></span><br><span class="line">            <span class="attr">positions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="keyword">function</span> (<span class="params">time, result</span>) &#123;</span><br><span class="line">                <span class="comment">//console.log(&quot;len: &quot;, lenInMeters, &quot;samplesNum&quot;, samplesNum, &quot;timeOfResolution&quot;, timeOfResolution);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//let st</span></span><br><span class="line">                curSegmentNo = <span class="title class_">Math</span>.<span class="title function_">floor</span>(</span><br><span class="line">                    <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, stTime) / timeOfResolution</span><br><span class="line">                );</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(curSegmentNo);</span><br><span class="line">                <span class="keyword">if</span> (curSegmentNo !== lastSegementNo) &#123;</span><br><span class="line">                    <span class="comment">//console.log(&quot;curSegmentNo is: &quot;, curSegmentNo.toString(), &quot;\ncurTime: &quot;, time.toString(), &quot;\nstTime: &quot;, stTime.toString());</span></span><br><span class="line">                    <span class="comment">// tmmP =&gt; curPolyine[lastSegementNo+1 : CurSegmentNo]</span></span><br><span class="line">                    <span class="keyword">let</span> tmpP = <span class="title class_">Cesium</span>.<span class="property">Ellipsoid</span>.<span class="property">WGS84</span>.<span class="title function_">cartographicToCartesian</span>(</span><br><span class="line">                        sampledPositions[curSegmentNo]</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">//console.log(&quot;adding new points: &quot;, tmpP.toString(), &quot;\nsize is:&quot;, curPolyline.length);</span></span><br><span class="line">                    curPolyline.<span class="title function_">push</span>(tmpP);</span><br><span class="line">                    lastSegementNo = curSegmentNo;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// if reach the end of sampled positions, clear the polyline&#x27;s positions</span></span><br><span class="line">                <span class="keyword">if</span> (curSegmentNo === samplesNum - <span class="number">1</span>) &#123;</span><br><span class="line">                    curSegmentNo = <span class="number">0</span>;</span><br><span class="line">                    curPolyline = [];</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;cleared!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> curPolyline;</span><br><span class="line">            &#125;, isConstant),</span><br><span class="line">            <span class="comment">//clampToGround: true,</span></span><br><span class="line">            <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">            <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">                    <span class="attr">start</span>: stTime,</span><br><span class="line">                    <span class="attr">stop</span>: endTime,</span><br><span class="line">                &#125;),</span><br><span class="line">            ]),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end adding polyline&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Compute the entity position property.</span></span><br><span class="line">    <span class="comment">//var position = computeCirclularFlight(-112.110693, 36.0994841, 0.03);</span></span><br><span class="line">    <span class="keyword">var</span> position = carPositionProperty;</span><br><span class="line">    <span class="comment">//Actually create the entity</span></span><br><span class="line">    <span class="keyword">var</span> entity = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">        <span class="comment">//Set the entity availability to the same interval as the simulation time.</span></span><br><span class="line">        <span class="attr">availability</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeIntervalCollection</span>([</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">TimeInterval</span>(&#123;</span><br><span class="line">                <span class="attr">start</span>: start,</span><br><span class="line">                <span class="attr">stop</span>: stop,</span><br><span class="line">            &#125;),</span><br><span class="line">        ]),</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Use our computed positions</span></span><br><span class="line">        <span class="attr">position</span>: position,</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Automatically compute orientation based on position movement.</span></span><br><span class="line">        <span class="attr">orientation</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">VelocityOrientationProperty</span>(position),</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Load the Cesium plane model to represent the entity</span></span><br><span class="line">        <span class="attr">model</span>: &#123;</span><br><span class="line">            <span class="attr">uri</span>: <span class="string">&quot;../SampleData/models/CesiumAir/Cesium_Air.glb&quot;</span>,</span><br><span class="line">            <span class="attr">minimumPixelSize</span>: <span class="number">64</span>,</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Show the path as a pink line sampled in 1 second increments.</span></span><br><span class="line">        <span class="attr">path</span>: &#123;</span><br><span class="line">            <span class="attr">resolution</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">material</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">PolylineGlowMaterialProperty</span>(&#123;</span><br><span class="line">                <span class="attr">glowPower</span>: <span class="number">0.1</span>,</span><br><span class="line">                <span class="attr">color</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">YELLOW</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="attr">width</span>: <span class="number">1</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add button to view the path from the top down</span></span><br><span class="line">    <span class="title class_">Sandcastle</span>.<span class="title function_">addDefaultToolbarButton</span>(<span class="string">&quot;View Top Down&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        viewer.<span class="property">trackedEntity</span> = <span class="literal">undefined</span>;</span><br><span class="line">        viewer.<span class="title function_">zoomTo</span>(</span><br><span class="line">            viewer.<span class="property">entities</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">HeadingPitchRange</span>(<span class="number">0</span>, <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">90</span>))</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add button to view the path from the side</span></span><br><span class="line">    <span class="title class_">Sandcastle</span>.<span class="title function_">addToolbarButton</span>(<span class="string">&quot;View Side&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        viewer.<span class="property">trackedEntity</span> = <span class="literal">undefined</span>;</span><br><span class="line">        viewer.<span class="title function_">zoomTo</span>(</span><br><span class="line">            viewer.<span class="property">entities</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">HeadingPitchRange</span>(</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">90</span>),</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">15</span>),</span><br><span class="line">                <span class="number">7500</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add button to track the entity as it moves</span></span><br><span class="line">    <span class="title class_">Sandcastle</span>.<span class="title function_">addToolbarButton</span>(<span class="string">&quot;View Aircraft&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// viewer.trackedEntity = entity;</span></span><br><span class="line">        viewer.<span class="title function_">zoomTo</span>(</span><br><span class="line">            viewer.<span class="property">entities</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">HeadingPitchRange</span>(</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(<span class="number">15</span>),</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(-<span class="number">45</span>),</span><br><span class="line">                <span class="number">2500</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add a combo box for selecting each interpolation mode.</span></span><br><span class="line">    <span class="title class_">Sandcastle</span>.<span class="title function_">addToolbarMenu</span>(</span><br><span class="line">        [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">text</span>: <span class="string">&quot;Interpolation: Linear Approximation&quot;</span>,</span><br><span class="line">                <span class="attr">onselect</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    entity.<span class="property">position</span>.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">                        <span class="attr">interpolationDegree</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">LinearApproximation</span>,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">text</span>: <span class="string">&quot;Interpolation: Lagrange Polynomial Approximation&quot;</span>,</span><br><span class="line">                <span class="attr">onselect</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    entity.<span class="property">position</span>.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">                        <span class="attr">interpolationDegree</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">LagrangePolynomialApproximation</span>,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">text</span>: <span class="string">&quot;Interpolation: Hermite Polynomial Approximation&quot;</span>,</span><br><span class="line">                <span class="attr">onselect</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    entity.<span class="property">position</span>.<span class="title function_">setInterpolationOptions</span>(&#123;</span><br><span class="line">                        <span class="attr">interpolationDegree</span>: <span class="number">2</span>,</span><br><span class="line">                        <span class="attr">interpolationAlgorithm</span>: <span class="title class_">Cesium</span>.<span class="property">HermitePolynomialApproximation</span>,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;interpolationMenu&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4 参考"></a>4 参考</h2><ul>
<li>1 回调函数的例子<a target="_blank" rel="noopener" href="https://sandcastle.cesium.com/?src=Callback%20Property.html">https://sandcastle.cesium.com/?src=Callback%20Property.html</a></li>
<li>2 贴地运动的例子<a target="_blank" rel="noopener" href="https://sandcastle.cesium.com/index.html?src=Clamp%20to%20Terrain.html">https://sandcastle.cesium.com/index.html?src=Clamp%20to%20Terrain.html</a></li>
<li>3 按照折线改变方向的例子<a target="_blank" rel="noopener" href="https://sandcastle.cesium.com/index.html?src=Interpolation.html">https://sandcastle.cesium.com/index.html?src=Interpolation.html</a></li>
<li>4 贴地函数文档<a target="_blank" rel="noopener" href="https://cesium.com/docs/cesiumjs-ref-doc/sampleTerrain.html">https://cesium.com/docs/cesiumjs-ref-doc/sampleTerrain.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/05/29/paxos/paxos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/29/paxos/paxos/" class="post-title-link" itemprop="url">paxo 分布式一致性算法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-29 15:24:18" itemprop="dateCreated datePublished" datetime="2021-05-29T15:24:18+08:00">2021-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/algo/" itemprop="url" rel="index"><span itemprop="name">algo</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/algo/dist/" itemprop="url" rel="index"><span itemprop="name">dist</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0-paxos算法解决了什么问题"><a href="#0-paxos算法解决了什么问题" class="headerlink" title="0 paxos算法解决了什么问题"></a>0 paxos算法解决了什么问题</h2><p>现在有n个人组成提一个会议，这个会议的目的是为了确定今年的税率，那么每个人都会提出自己认为的今年的合理的税率，为了大家能够达成一致，有了paxos算法。实际里，这个会议就是一个集群。</p>
<h2 id="1-paxos算法详解"><a href="#1-paxos算法详解" class="headerlink" title="1 paxos算法详解"></a>1 paxos算法详解</h2><h3 id="1-1-基本概念"><a href="#1-1-基本概念" class="headerlink" title="1.1 基本概念"></a>1.1 基本概念</h3><ul>
<li><ol>
<li>角色：<br>提议者(proposer)：提议的发起者。<br>批准者(acceptor)：对提议进行批准。<br>学习者(learner)：作为一致性协议的副本因子，对被超过半数的 acceptor<br>批准的方案进行学习。</li>
</ol>
</li>
<li><ol start="2">
<li>提议(propose)：<br>Proposer(提议者)可以提出提议，最终要达成一致的 value 就在提议里。Acceptor(接收者)根据提议的编号来选择是否接受(accept)提议。如果超过半数的cceptor 接收了一个提议，那么这个提议就被接受(accepted)了，提议里的 value 也就被选定了。</li>
</ol>
</li>
<li><ol start="3">
<li>仲裁集合(Quorums)： 是 Acceptor(假设有 N 个)的一个子集，任何两个 Quorums 至少有一个相同的成员，也就是说一个 quorums 是一个包含了超过 N/2+1 个 Acceptor 的一个集合。</li>
</ol>
</li>
<li><ol start="4">
<li>提议序号(Proposal number)和批准值(agreed value)：对于任意一个给定的提议者，其给定的提议对应的提议号必定全局唯一。每一个提议(n,v 代表的话)都有一个提议序号(n)和其想要通过的提议值(v)，为了便于理解，设想一个权力机关去决定今年的税率，那么每个人会给自己的提议有一个全局唯一的序号(n)，然后还包含对于想要决定的目标变量(税率)的值(n)也就是税率的大小。</li>
</ol>
</li>
</ul>
<h3 id="1-2-算法具体流程"><a href="#1-2-算法具体流程" class="headerlink" title="1.2 算法具体流程"></a>1.2 算法具体流程</h3><p>Paxos(这里主要说的是 Basic paxos 算法)的具体流程分为两阶段：</p>
<h4 id="Phase1"><a href="#Phase1" class="headerlink" title="Phase1"></a><strong>Phase1</strong></h4><ul>
<li><strong>(1) Phase 1a - proposer 准备(Prepare)：</strong><br>Proposer 创建一个条消息，我们将其称为“Prepare”，以数字 n 标识。请注意，n 不是要提议的值也不是可能会被同意的商定的值，而只是一个数字，该数字由提议者唯一标识此初始消息（发送给接收者）。数字 n 必须大于此提议者在先前的任何 Prepare 消息中使用的任何数字。然后，它将包含 n 的 Prepare消息发送到接受方的一个仲裁集合(超过一半以上的 Acceptor 的集合)。请注意，Prepare 消息仅包含数字 n（也就是说，它不必包含例如建议的值，通常用 v 表示）。提议者决定谁在仲裁集合。如果提议者不能与至少一个接受者的仲裁集合进行通信，则他不应启动 Paxos。 </li>
<li><strong>(2) Phase 1b - acceptor 承诺(Promise)：</strong><br>任何接受者都在等待来自任何提议者的准备消息。如果接受方收到一条准备消息，则接受方必须查看刚刚收到的准备消息的标识符编号 n。有两种情况：  <ul>
<li><ol>
<li>如果 n 高于接受者从任何提议者接收到的每个先前的提议编号，那么接受者必须向提议者返回一条消息，我们称其为“承诺”，以忽略所有将来的提议数量少的提议比 n。如果接受者在过去某个时候接受了提议者的提议(也就是第二阶段中批准的提议)，则在对提议者的答复中必须包含先前接受的的提议编号（例如 m）和相应的接受(批准)值（例如 w）。  </li>
</ol>
</li>
<li><ol start="2">
<li>否则（即，n 小于或等于接受者从任何提议者收到的任何先前提议编号），接受者可以忽略收到的提议。在这种情况下，Paxos 不必工作。但是，为了优化起见，发送拒绝（Nack）响应将告诉提议者它停止以 n 作为提议的序号去建立共识(这是优化手段，因为即使不主动告诉，其提议的序号也会增长)。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h4 id="Phase2"><a href="#Phase2" class="headerlink" title="Phase2"></a><strong>Phase2</strong></h4><ul>
<li><strong>(1) Phase 2a - proposer 发送 Accept 消息：</strong><ul>
<li>1 如果提议者从接受者的一个仲裁集合中获得大部分承诺，则需要为其提议设置值 v。</li>
<li>2 如果任何接受者先前已接受过一个提议，那么他们会将这个提议发送给提议者，提议者现在必须将其提议值 v 设置为与接受者报告的(与这些接受者最高提议编号关联的)提议值(也就是提议者之前接受过的提议)，我们称之为 z。</li>
<li>3 如果到目前为止，没有一个接受者接受提议，则提<br>议者可以选择其最初想要提议的值，例如 x。<br>在这个阶段，提议者会发送一个 Accept 信息：(n,v)给一个接受者个仲裁集合。(n 就是之前提议者发给接受者的准备信息里的提议里的提议序号。v=z 或 者 v=x (当所有接受者都没有接受过提议时。))，这个 accept 请求可以理解为一个请求：“请接受这个提议！”。</li>
</ul>
</li>
<li><strong>(2) Phase 2b - acceptor 发送 Accepted 消息：</strong><br>如果接受者从提议者接收到 Accept 信息（n，v），分为两种情况：<ul>
<li>1 如果：它尚未承诺（在 Paxos 协议的阶段 1b 中）仅考虑提议序号大于 n 的提议时，则它应该将（刚接收到的 Accept 消息的）值 v 注册为（协议）的接受值，并向提议者和每个学习者（通常是提议者本身）发送一条接受消息。</li>
<li>2 否则：它可以忽略这个 Accept 消息。</li>
</ul>
</li>
</ul>
<h3 id="1-3-paxos算法的活锁问题"><a href="#1-3-paxos算法的活锁问题" class="headerlink" title="1.3 paxos算法的活锁问题"></a>1.3 paxos算法的活锁问题</h3><p>如上图，(从上图也可以看出集群里的一个机器可以有多重身份)首先 s1-3 给出 3 个 preparemeesage，然后 s1-3 是一个 quorum 得到了大多数支持，开始发送 phase2-a 的 accept 信息(A3.1)，但是由于在发送phase2-a 的 accept 消息之前，s3-5 给出 3 个 prepare message，s3 又更新了自己主张的提议，那么之前发送的(accept 信息)A3.1 就不会被回应，之后 s1-2 发现由于超过半数(s3-5)拒绝了自己，然后就出了新的一轮 prepare message 为 P4.1，<br>然后，就这样循环往复下去出现了活锁。</p>
<p>其改进方法：</p>
<ul>
<li>解决方案1：出现冲突的时候，在重新开始执行prepare message流程之前，施加随机的延迟；让其他proposers有机会完成value的确认</li>
<li>解决方案2：multi-paxos会使用leader来避免活锁；</li>
</ul>
<h2 id="2-paxos算法实现"><a href="#2-paxos算法实现" class="headerlink" title="2 paxos算法实现"></a>2 paxos算法实现</h2><h3 id="2-1-paxos-cpp"><a href="#2-1-paxos-cpp" class="headerlink" title="2.1 paxos.cpp"></a>2.1 paxos.cpp</h3><p>模拟paxos算法的主要流程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Paxos/Acceptor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Paxos/Proposer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib/Thread.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib/Lock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib/mapi.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib/atom.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;lib/Logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">paxos::Proposer p[<span class="number">5</span>];</span><br><span class="line">paxos::Acceptor a[<span class="number">11</span>];</span><br><span class="line">mdk::Mutex l[<span class="number">11</span>];</span><br><span class="line"><span class="type">int</span> finishedCount = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> finalValue = <span class="number">-1</span>;</span><br><span class="line"><span class="type">bool</span> isFinished = <span class="literal">false</span>;</span><br><span class="line">mdk::uint64 g_start;</span><br><span class="line">mdk::Logger g_log;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">Proposer</span><span class="params">(<span class="type">void</span> *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mdk::Logger log;</span><br><span class="line">	<span class="type">char</span> logName[<span class="number">256</span>];</span><br><span class="line">	<span class="built_in">sprintf</span>( logName, <span class="string">&quot;Proposer%d&quot;</span>, (<span class="type">long</span>)id );</span><br><span class="line">	log.<span class="built_in">SetLogName</span>(logName);</span><br><span class="line">	log.<span class="built_in">SetMaxLogSize</span>(<span class="number">10</span>);</span><br><span class="line">	log.<span class="built_in">SetMaxExistDay</span>(<span class="number">30</span>);</span><br><span class="line">	log.<span class="built_in">SetPrintLog</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	paxos::Proposer &amp;proposer = p[(<span class="type">long</span>)id];</span><br><span class="line">	paxos::PROPOSAL value = proposer.<span class="built_in">GetProposal</span>();</span><br><span class="line">	paxos::PROPOSAL lastValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> acceptorId[<span class="number">11</span>];</span><br><span class="line">	<span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	mdk::uint64 start = mdk::<span class="built_in">MillTime</span>();</span><br><span class="line">	<span class="keyword">while</span> ( <span class="literal">true</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		value = proposer.<span class="built_in">GetProposal</span>();<span class="comment">//拿到提议</span></span><br><span class="line">		log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Proposer%d号开始(Propose阶段):提议=[编号:%d，提议:%d]\n&quot;</span>, </span><br><span class="line">			(<span class="type">long</span>)id, value.serialNum, value.value);</span><br><span class="line">		count = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i++ )</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			* 发送消息到第i个acceptor</span></span><br><span class="line"><span class="comment">			* 经过一定时间达到acceptor，sleep(随机时间)模拟</span></span><br><span class="line"><span class="comment">			* acceptor处理消息，mAcceptors[i].Propose()</span></span><br><span class="line"><span class="comment">			* 回应proposer</span></span><br><span class="line"><span class="comment">			* 经过一定时间proposer收到回应，sleep(随机时间)模拟</span></span><br><span class="line"><span class="comment">			* proposer处理回应mProposer.proposed(ok, lastValue)</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">			mdk::<span class="built_in">m_sleep</span>(<span class="built_in">rand</span>()%<span class="number">500</span>);<span class="comment">//经过随机时间，消息到达了mAcceptors[i]</span></span><br><span class="line">			<span class="comment">//处理消息</span></span><br><span class="line">			l[i].<span class="built_in">Lock</span>();</span><br><span class="line">			<span class="type">bool</span> ok = a[i].<span class="built_in">Propose</span>(value.serialNum, lastValue);</span><br><span class="line">			l[i].<span class="built_in">Unlock</span>();</span><br><span class="line">			mdk::<span class="built_in">m_sleep</span>(<span class="built_in">rand</span>()%<span class="number">500</span>);<span class="comment">//经过随机时间,消息到达Proposer</span></span><br><span class="line">			<span class="comment">//处理Propose回应</span></span><br><span class="line">			<span class="keyword">if</span> ( !proposer.<span class="built_in">Proposed</span>(ok, lastValue) ) <span class="comment">//重新开始Propose阶段</span></span><br><span class="line">			&#123;</span><br><span class="line">				mdk::<span class="built_in">m_sleep</span>(<span class="number">1000</span>);<span class="comment">//为了降低活锁，多等一会让别的proposer有机会完成自己的2阶段批准</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			paxos::PROPOSAL curValue = proposer.<span class="built_in">GetProposal</span>();<span class="comment">//拿到提议</span></span><br><span class="line">			<span class="keyword">if</span> ( curValue.value != value.value )<span class="comment">//acceptor本次回应可能推荐了一个提议</span></span><br><span class="line">			&#123;</span><br><span class="line">				log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Proposer%d号修改了提议:提议=[编号:%d，提议:%d]\n&quot;</span>, </span><br><span class="line">					(<span class="type">long</span>)id, curValue.serialNum, curValue.value);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			acceptorId[count++] = i;<span class="comment">//记录愿意投票的acceptor</span></span><br><span class="line">			<span class="keyword">if</span> ( proposer.<span class="built_in">StartAccept</span>() ) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//检查有没有达到Accept开始条件，如果没有表示要重新开始Propose阶段</span></span><br><span class="line">		<span class="keyword">if</span> ( !proposer.<span class="built_in">StartAccept</span>() ) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//开始Accept阶段</span></span><br><span class="line">		<span class="comment">//发送Accept消息到所有愿意投票的acceptor</span></span><br><span class="line">		value = proposer.<span class="built_in">GetProposal</span>();</span><br><span class="line">		log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Proposer%d号开始(Accept阶段):提议=[编号:%d，提议:%d]\n&quot;</span>, </span><br><span class="line">			(<span class="type">long</span>)id, value.serialNum, value.value);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++ )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//发送accept消息到acceptor</span></span><br><span class="line">			<span class="comment">//减少accept阶段等待时间，加快收敛</span></span><br><span class="line">			mdk::<span class="built_in">m_sleep</span>(<span class="built_in">rand</span>()%<span class="number">200</span>);<span class="comment">//经过随机时间,accept消息到达acceptor</span></span><br><span class="line">			<span class="comment">//处理accept消息</span></span><br><span class="line">			l[acceptorId[i]].<span class="built_in">Lock</span>();</span><br><span class="line">			<span class="type">bool</span> ok = a[acceptorId[i]].<span class="built_in">Accept</span>(value);</span><br><span class="line">			l[acceptorId[i]].<span class="built_in">Unlock</span>();</span><br><span class="line">			mdk::<span class="built_in">m_sleep</span>(<span class="built_in">rand</span>()%<span class="number">200</span>);<span class="comment">//经过随机时间,accept回应到达proposer</span></span><br><span class="line">			<span class="comment">//处理accept回应</span></span><br><span class="line">			<span class="keyword">if</span> ( !proposer.<span class="built_in">Accepted</span>(ok) ) <span class="comment">//重新开始Propose阶段</span></span><br><span class="line">			&#123;</span><br><span class="line">				mdk::<span class="built_in">m_sleep</span>(<span class="number">1000</span>);<span class="comment">//为了降低活锁，多等一会让别的proposer有机会完成自己的2阶段批准</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ( proposer.<span class="built_in">IsAgree</span>() )<span class="comment">//成功批准了提议</span></span><br><span class="line">			&#123;</span><br><span class="line">				start = mdk::<span class="built_in">MillTime</span>() - start;</span><br><span class="line">				log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Proposer%d号的提议被批准,用时%lluMS:最终提议 = [编号:%d，提议:%d]\n&quot;</span>, (<span class="type">long</span>)id, start, value.serialNum, value.value);</span><br><span class="line">				g_log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Proposer%d号的提议被批准,用时%lluMS:最终提议 = [编号:%d，提议:%d]\n&quot;</span>, (<span class="type">long</span>)id, start, value.serialNum, value.value);</span><br><span class="line">				<span class="keyword">if</span>(finalValue == <span class="number">-1</span>) finalValue = value.value;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(finalValue != value.value) finalValue = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> ( <span class="number">4</span> == mdk::<span class="built_in">AtomAdd</span>(&amp;finishedCount, <span class="number">1</span>) )</span><br><span class="line">				&#123;</span><br><span class="line">					isFinished = <span class="literal">true</span>;</span><br><span class="line">					g_start = mdk::<span class="built_in">MillTime</span>() - g_start;</span><br><span class="line">					<span class="keyword">if</span>(finalValue &gt; <span class="number">0</span>)&#123;</span><br><span class="line">						g_log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Paxos完成，用时%lluMS，最终通过提议值为：%d\n&quot;</span>, g_start, finalValue);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;</span><br><span class="line">						g_log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Paxos完成，用时%lluMS，最终结果不一致！\n&quot;</span>, g_start);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Paxos过程模拟演示程序</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	g_log.<span class="built_in">SetLogName</span>(<span class="string">&quot;Paxos&quot;</span>);</span><br><span class="line">	g_log.<span class="built_in">SetMaxLogSize</span>(<span class="number">10</span>);</span><br><span class="line">	g_log.<span class="built_in">SetMaxExistDay</span>(<span class="number">30</span>);</span><br><span class="line">	g_log.<span class="built_in">SetPrintLog</span>(<span class="literal">true</span>);</span><br><span class="line">	g_log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;5个Proposer, 11个Acceptor准备进行Paxos\n&quot;</span></span><br><span class="line">		<span class="string">&quot;每个Proposer独立线程，Acceptor不需要线程\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Proposer编号从0-10,编号为i的Proposer初始提议编号和提议值是（i+1, i+1）\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Proposer每次重新提议会将提议编号增加5\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Proposer被批准后结束线程,其它线程继续投票最终，全部批准相同的值，达成一致。\n&quot;</span>);</span><br><span class="line">	g_start = mdk::<span class="built_in">MillTime</span>();</span><br><span class="line">	g_log.<span class="built_in">Info</span>(<span class="string">&quot;Info&quot;</span>, <span class="string">&quot;Paxos开始\n&quot;</span> );</span><br><span class="line">	paxos::PROPOSAL value;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ ) </span><br><span class="line">	&#123;</span><br><span class="line">		p[i].<span class="built_in">SetPlayerCount</span>(<span class="number">5</span>, <span class="number">11</span>);</span><br><span class="line">		value.serialNum = value.value = i + <span class="number">1</span>;</span><br><span class="line">		p[i].<span class="built_in">StartPropose</span>(value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mdk::Thread t[<span class="number">5</span>];</span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ ) t[i].<span class="built_in">Run</span>(Proposer, (<span class="type">void</span>*)i);</span><br><span class="line">	<span class="comment">//for ( i = 0; i &lt; 5; i++ ) t[i].WaitStop();</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(isFinished) <span class="keyword">break</span>;</span><br><span class="line">		mdk::<span class="built_in">m_sleep</span>(<span class="number">500</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-proposer-cpp"><a href="#2-2-proposer-cpp" class="headerlink" title="2.2 proposer.cpp"></a>2.2 proposer.cpp</h3><p>模拟提议者的主要流程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Proposer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> paxos</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">Proposer::<span class="built_in">Proposer</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">SetPlayerCount</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Proposer::<span class="built_in">Proposer</span>(<span class="type">short</span> proposerCount, <span class="type">short</span> acceptorCount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">SetPlayerCount</span>(proposerCount, acceptorCount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Proposer::~<span class="built_in">Proposer</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Proposer::SetPlayerCount</span><span class="params">(<span class="type">short</span> proposerCount, <span class="type">short</span> acceptorCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_proposerCount = proposerCount;</span><br><span class="line">	m_acceptorCount = acceptorCount;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Proposer::StartPropose</span><span class="params">(PROPOSAL &amp;value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_value = value;</span><br><span class="line">	m_proposeFinished = <span class="literal">false</span>;</span><br><span class="line">	m_isAgree = <span class="literal">false</span>;</span><br><span class="line">	m_maxAcceptedSerialNum = <span class="number">0</span>;</span><br><span class="line">	m_okCount = <span class="number">0</span>;</span><br><span class="line">	m_refuseCount = <span class="number">0</span>;</span><br><span class="line">	m_start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PROPOSAL&amp; <span class="title">Proposer::GetProposal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">//提议者</span></span><br><span class="line"><span class="comment">class Proposer</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">public:</span></span><br><span class="line"><span class="comment">	Proposer();</span></span><br><span class="line"><span class="comment">	Proposer(short proposerCount, short acceptorCount);</span></span><br><span class="line"><span class="comment">	virtual ~Proposer();</span></span><br><span class="line"><span class="comment">	//设置参与者数量</span></span><br><span class="line"><span class="comment">	void SetPlayerCount(short proposerCount, short acceptorCount);</span></span><br><span class="line"><span class="comment">	//开始Propose阶段</span></span><br><span class="line"><span class="comment">	void StartPropose(PROPOSAL &amp;value);</span></span><br><span class="line"><span class="comment">	//取得提议</span></span><br><span class="line"><span class="comment">	PROPOSAL&amp; GetProposal();</span></span><br><span class="line"><span class="comment">	//提议被投票，Proposed失败则重新开始Propose阶段</span></span><br><span class="line"><span class="comment">	bool Proposed(bool ok, PROPOSAL &amp;lastAcceptValue);</span></span><br><span class="line"><span class="comment">	//开始Accept阶段,满足条件成功开始accept阶段返回ture，不满足开始条件返回false</span></span><br><span class="line"><span class="comment">	bool StartAccept();</span></span><br><span class="line"><span class="comment">	//提议被接受，Accepted失败则重新开始Propose阶段</span></span><br><span class="line"><span class="comment">	bool Accepted(bool ok);</span></span><br><span class="line"><span class="comment">	//提议被批准</span></span><br><span class="line"><span class="comment">	bool IsAgree();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">private:</span></span><br><span class="line"><span class="comment">	short			m_proposerCount;///proposer数量</span></span><br><span class="line"><span class="comment">	short			m_acceptorCount;//acceptor数量</span></span><br><span class="line"><span class="comment">	PROPOSAL		m_value;//预备提议</span></span><br><span class="line"><span class="comment">	bool			m_proposeFinished;//完成拉票，准备开始二阶段</span></span><br><span class="line"><span class="comment">	bool			m_isAgree;//m_value被批准</span></span><br><span class="line"><span class="comment">	unsigned int	m_maxAcceptedSerialNum;//已被接受的提议中流水号最大的</span></span><br><span class="line"><span class="comment">	time_t			m_start;//阶段开始时间，阶段一，阶段二共用</span></span><br><span class="line"><span class="comment">	short			m_okCount;//投票数量，阶段一，阶段二共用</span></span><br><span class="line"><span class="comment">	short			m_refuseCount;//拒绝数量，阶段一，阶段二共用</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//提议数据结构</span></span><br><span class="line"><span class="comment">	typedef struct PROPOSAL</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		unsigned int	serialNum;//流水号,1开始递增，保证全局唯一</span></span><br><span class="line"><span class="comment">		unsigned int	value;//提议内容</span></span><br><span class="line"><span class="comment">	&#125;PROPOSAL;</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Proposer::Proposed</span><span class="params">(<span class="type">bool</span> ok, PROPOSAL &amp;lastAcceptValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( m_proposeFinished ) <span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//可能是一阶段迟到的回应，直接忽略消息</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !ok ) </span><br><span class="line">	&#123;</span><br><span class="line">		m_refuseCount++;</span><br><span class="line">		<span class="comment">//已有半数拒绝，不需要等待其它acceptor投票了，重新开始Propose阶段</span></span><br><span class="line">		<span class="comment">//使用StartPropose(m_value)重置状态</span></span><br><span class="line">	</span><br><span class="line">        <span class="comment">//请完善下面逻辑</span></span><br><span class="line"> 		<span class="comment">/**********Begin**********/</span></span><br><span class="line">        <span class="keyword">if</span> ( m_refuseCount &gt; m_acceptorCount/<span class="number">2</span> )&#123;</span><br><span class="line">            <span class="comment">// 重新开始投票阶段，将提案号自增</span></span><br><span class="line">            m_value.serialNum += <span class="number">5</span>;</span><br><span class="line">            <span class="built_in">StartPropose</span>(m_value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	    <span class="comment">/**********End**********/</span></span><br><span class="line">		<span class="comment">//拒绝数不到一半</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_okCount++;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		没有必要检查分支：serialNum为null</span></span><br><span class="line"><span class="comment">		因为serialNum&gt;m_maxAcceptedSerialNum，与serialNum非0互为必要条件</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">//如果已经有提议被接受，修改成已被接受的提议</span></span><br><span class="line">	<span class="comment">//请完善下面逻辑</span></span><br><span class="line"> 	<span class="comment">/**********Begin**********/</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span>(lastAcceptValue.serialNum &gt; m_maxAcceptedSerialNum)&#123;</span><br><span class="line">        m_value.value = lastAcceptValue.value;</span><br><span class="line">        m_maxAcceptedSerialNum = lastAcceptValue.serialNum;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/**********End**********/</span>	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果自己的提议被接受</span></span><br><span class="line">	<span class="keyword">if</span> ( m_okCount &gt; m_acceptorCount / <span class="number">2</span> ) </span><br><span class="line">	&#123;</span><br><span class="line">		m_okCount = <span class="number">0</span>;</span><br><span class="line">		m_proposeFinished = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Proposer::StartAccept</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m_proposeFinished;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Proposer::Accepted</span><span class="params">(<span class="type">bool</span> ok)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( !m_proposeFinished ) <span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//可能是上次第二阶段迟到的回应，直接忽略消息</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !ok ) </span><br><span class="line">	&#123;</span><br><span class="line">		m_refuseCount++;</span><br><span class="line">		<span class="comment">//已有半数拒绝，不需要等待其它acceptor投票了，重新开始Propose阶段</span></span><br><span class="line">		<span class="comment">//使用StartPropose(m_value)重置状态</span></span><br><span class="line">	    <span class="comment">//请完善下面逻辑</span></span><br><span class="line">        <span class="comment">/**********Begin**********/</span></span><br><span class="line">        <span class="keyword">if</span> ( m_refuseCount &gt; m_acceptorCount/<span class="number">2</span> )&#123;</span><br><span class="line">            <span class="comment">// 重新开始投票阶段，将提案号自增</span></span><br><span class="line">            m_value.serialNum += <span class="number">5</span>;</span><br><span class="line">            <span class="built_in">StartPropose</span>(m_value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**********End**********/</span></span><br><span class="line"> 		</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_okCount++;</span><br><span class="line">	<span class="keyword">if</span> ( m_okCount &gt; m_acceptorCount / <span class="number">2</span> ) m_isAgree = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Proposer::IsAgree</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m_isAgree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-acceptor-cpp"><a href="#2-3-acceptor-cpp" class="headerlink" title="2.3 acceptor.cpp"></a>2.3 acceptor.cpp</h3><p>模拟接受者的主要流程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Acceptor.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> paxos</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Acceptor::<span class="built_in">Acceptor</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	m_maxSerialNum = <span class="number">0</span>;</span><br><span class="line">	m_lastAcceptValue.serialNum = <span class="number">0</span>;</span><br><span class="line">	m_lastAcceptValue.value = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Acceptor::~<span class="built_in">Acceptor</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">//投票者</span></span><br><span class="line"><span class="comment">class Acceptor</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">public:</span></span><br><span class="line"><span class="comment">	Acceptor(void);</span></span><br><span class="line"><span class="comment">	virtual ~Acceptor(void);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//同意投票</span></span><br><span class="line"><span class="comment">	bool Propose(unsigned int serialNum, PROPOSAL &amp;lastAcceptValue);</span></span><br><span class="line"><span class="comment">	//接受提议</span></span><br><span class="line"><span class="comment">	bool Accept(PROPOSAL &amp;value);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">private:</span></span><br><span class="line"><span class="comment">	PROPOSAL		m_lastAcceptValue;//最后接受的提议</span></span><br><span class="line"><span class="comment">	unsigned int	m_maxSerialNum;//Propose提交的最大流水号</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//提议数据结构</span></span><br><span class="line"><span class="comment">	typedef struct PROPOSAL</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		unsigned int	serialNum;//流水号,1开始递增，保证全局唯一</span></span><br><span class="line"><span class="comment">		unsigned int	value;//提议内容</span></span><br><span class="line"><span class="comment">	&#125;PROPOSAL;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">***/</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Acceptor::Propose</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> serialNum, PROPOSAL &amp;lastAcceptValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="number">0</span> == serialNum ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">//提议不通过</span></span><br><span class="line">	<span class="keyword">if</span> ( m_maxSerialNum &gt; serialNum ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">//接受提议</span></span><br><span class="line">    <span class="comment">//请完善下面逻辑</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**********Begin**********/</span></span><br><span class="line">    <span class="comment">//m_lastAcceptValue = lastAcceptValue;</span></span><br><span class="line">    <span class="comment">// If n is higher than every previous proposal number received, from any of the Proposers, by the Acceptor, </span></span><br><span class="line">    <span class="comment">// then the Acceptor must return a message, which we call a &quot;Promise&quot;, to the Proposer, to ignore all future </span></span><br><span class="line">    <span class="comment">// proposals having a number less than n. If the Acceptor accepted a proposal at some point in the past, it </span></span><br><span class="line">    <span class="comment">// must include the previous proposal number, say m, and the corresponding accepted value, say w, in its response to the Proposer.</span></span><br><span class="line">    m_maxSerialNum = serialNum;</span><br><span class="line">    </span><br><span class="line">    lastAcceptValue = m_lastAcceptValue; <span class="comment">// which contains m -&gt; w</span></span><br><span class="line">	<span class="comment">/**********End**********/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Acceptor::Accept</span><span class="params">(PROPOSAL &amp;value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="number">0</span> == value.serialNum ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">//Acceptor又重新答应了其他提议</span></span><br><span class="line">   <span class="comment">//请完善下面逻辑</span></span><br><span class="line">	<span class="comment">/**********Begin**********/</span></span><br><span class="line">    <span class="keyword">if</span> (m_maxSerialNum &gt; value.serialNum )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 然后接受新的提案</span></span><br><span class="line">    m_lastAcceptValue = value;</span><br><span class="line">	<span class="comment">/**********End**********/</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="comment">//批准提议通过</span></span><br><span class="line">    <span class="comment">//请完善下面逻辑</span></span><br><span class="line">    <span class="comment">/**********Begin**********/</span></span><br><span class="line">    m_maxSerialNum = value.serialNum;</span><br><span class="line">	<span class="comment">/**********End**********/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-参考"><a href="#3-参考" class="headerlink" title="3 参考"></a>3 参考</h2><p>[1] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Paxos_(computer_science)#Byzantine_Paxos">https://en.wikipedia.org/wiki/Paxos_(computer_science)#Byzantine_Paxos</a><br>[2] <a target="_blank" rel="noopener" href="https://www.cs.rutgers.edu/~pxk/417/notes/paxos.html">https://www.cs.rutgers.edu/~pxk/417/notes/paxos.html</a><br>[3] <a target="_blank" rel="noopener" href="https://github.com/HaHaJeff/Paxos/blob/master/basic_paxos.md">https://github.com/HaHaJeff/Paxos/blob/master/basic_paxos.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/05/24/fittingUsingParabolaCurve/fittedUsingParabolaCurve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/24/fittingUsingParabolaCurve/fittedUsingParabolaCurve/" class="post-title-link" itemprop="url">parabola fitting - 使用抛物线拟合离散点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-24 15:24:18" itemprop="dateCreated datePublished" datetime="2021-05-24T15:24:18+08:00">2021-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>给定<strong>地对空导弹</strong>发射起始点和终止点（3维坐标），拟合导弹轨迹</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>1 首先简单化问题，假定导弹轨迹位于同一个平面内，则可以将轨迹投影到x-O-z平面，先求出x-z的关系，求一系列的散点，<br>然后根据x,y的关系求出y的散点值即可</li>
<li>2 之所以选取抛物线，因为导弹轨迹需要垂直发射的过程，存在斜率不存在的点常见的曲线为抛物线和圆，由于圆显然不合适，我们选取抛物线</li>
</ul>
<h2 id="实现的数学逻辑"><a href="#实现的数学逻辑" class="headerlink" title="实现的数学逻辑"></a>实现的数学逻辑</h2><ul>
<li>1 起始点和终止点的定义：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># startPos and endPos in [lon, lat, height]</span><br><span class="line">stPos = [117.9844565, 24.1658956, 1.597]</span><br><span class="line">edPos = [118.1167438, 24.5656241, 5211.73]</span><br></pre></td></tr></table></figure></li>
<li>2 数学关系<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 由于整个轨迹位于一个平面内，则可以考虑x，y存在线性关系</span><br><span class="line">y1 = k * x1 + b</span><br><span class="line">y2 = k * x2 + b</span><br><span class="line">则y可以由x得到</span><br><span class="line"></span><br><span class="line"># [x1, y1, z1]为起始点，则有如下抛物线，根据终止点[x2, y2, z2]求出p</span><br><span class="line">(z-z1)**2 = p*(x-x1)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># set figure</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.gca(projection=<span class="string">&#x27;3d&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################## input args #############################################</span></span><br><span class="line"><span class="comment"># startPos and endPos in [lon, lat, height]</span></span><br><span class="line">stPos = [<span class="number">117.9844565</span>, <span class="number">24.1658956</span>, <span class="number">1.597</span>]</span><br><span class="line">edPos = [<span class="number">118.1167438</span>, <span class="number">24.5656241</span>, <span class="number">5211.73</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># # stTime, endTime, in seconds, assume it take 1 minute for missile from emit to explode</span></span><br><span class="line"><span class="comment"># stTime = 0</span></span><br><span class="line"><span class="comment"># endTime = 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step number</span></span><br><span class="line">stepNumber = <span class="number">30</span></span><br><span class="line"><span class="comment">################################################## input args #############################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################## output     #############################################</span></span><br><span class="line"><span class="comment"># res</span></span><br><span class="line">resX = []</span><br><span class="line">resY = []</span><br><span class="line">resZ = []</span><br><span class="line"><span class="comment">################################################## output     #############################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># land defend air means, should satisfy: st.z &lt; ed.z</span></span><br><span class="line"><span class="comment"># (z-z1)**2 = p*(x-x1)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">computeLnadDefendAirParabolaWithSteps</span>(<span class="params"></span></span><br><span class="line"><span class="params">    st,     <span class="comment"># start point: [x, y, z]</span></span></span><br><span class="line"><span class="params">    ed,     <span class="comment"># end point: [x, y, z]</span></span></span><br><span class="line"><span class="params">    resX,   <span class="comment"># x-axis&#x27;s result</span></span></span><br><span class="line"><span class="params">    resY,   <span class="comment"># y-axis&#x27;s result</span></span></span><br><span class="line"><span class="params">    resZ,   <span class="comment"># z-axis&#x27;s result</span></span></span><br><span class="line"><span class="params">    stepNum <span class="comment"># how may fitted points you want</span></span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">    resX.append(st[<span class="number">0</span>])</span><br><span class="line">    resY.append(st[<span class="number">1</span>])</span><br><span class="line">    resZ.append(st[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    p = (ed[<span class="number">2</span>] - st[<span class="number">2</span>])**<span class="number">2</span> / (ed[<span class="number">0</span>] - st[<span class="number">0</span>])</span><br><span class="line">    step = (ed[<span class="number">0</span>] - st[<span class="number">0</span>]) / stepNum</span><br><span class="line">    <span class="keyword">for</span> stepCnt <span class="keyword">in</span> <span class="built_in">range</span>(stepNum)[<span class="number">1</span>:]:</span><br><span class="line">        curX = st[<span class="number">0</span>] + stepCnt * step</span><br><span class="line">        curZ = (p * (curX - st[<span class="number">0</span>])) ** <span class="number">0.5</span> + st[<span class="number">2</span>]</span><br><span class="line">        resZ.append(curZ)</span><br><span class="line">        <span class="comment"># compute projection from x to y: x = k*y + b</span></span><br><span class="line">        <span class="keyword">if</span> st[<span class="number">1</span>] != ed[<span class="number">1</span>]:</span><br><span class="line">            k = (st[<span class="number">0</span>] - ed[<span class="number">0</span>]) / (st[<span class="number">1</span>] - ed[<span class="number">1</span>])</span><br><span class="line">            b = st[<span class="number">0</span>] - k * st[<span class="number">1</span>]</span><br><span class="line">            curY = (curX - b) / k</span><br><span class="line">            resY.append(curY)</span><br><span class="line">            resX.append(curX)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># all the y is the same</span></span><br><span class="line">            resY.append(curY)</span><br><span class="line">            resX.append(curX)</span><br><span class="line">    resX.append(ed[<span class="number">0</span>])</span><br><span class="line">    resY.append(ed[<span class="number">1</span>])</span><br><span class="line">    resZ.append(ed[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print</span></span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(stepNum + <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%10.6f, %10.6f, %10.3f&quot;</span>%(resX[idx], resY[idx], resZ[idx]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">computeLnadDefendAirParabolaWithSteps(stPos, edPos, resX, resY, resZ, stepNumber)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制图形</span></span><br><span class="line">ax.plot(resX, resY, resZ, label=<span class="string">&#x27;fitted curve&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示图例</span></span><br><span class="line">ax.legend()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示图形</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://xychen5.github.io/2021/05/24/lagrangeInterpolation/lagrangeInterpolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/xychen5/blogImgs@main/imgs/index3(复件).1h2t3p2cfiow.jpg">
      <meta itemprop="name" content="xychen5">
      <meta itemprop="description" content="Freiheit Weht">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuftBallon">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/24/lagrangeInterpolation/lagrangeInterpolation/" class="post-title-link" itemprop="url">pagrangeInterpolation for curve fitting - 使用拉格朗日插值平滑曲线</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-24 15:24:18" itemprop="dateCreated datePublished" datetime="2021-05-24T15:24:18+08:00">2021-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-03 19:50:26" itemprop="dateModified" datetime="2023-08-03T19:50:26+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="使用拉格朗日插值平滑曲线"><a href="#使用拉格朗日插值平滑曲线" class="headerlink" title="使用拉格朗日插值平滑曲线"></a>使用拉格朗日插值平滑曲线</h2><h3 id="1-平滑前后效果对比："><a href="#1-平滑前后效果对比：" class="headerlink" title="1 平滑前后效果对比："></a>1 平滑前后效果对比：</h3><h4 id="平滑前"><a href="#平滑前" class="headerlink" title="平滑前"></a>平滑前</h4><p><img src="./before.gif" alt="./before.gif"></p>
<h4 id="平滑后"><a href="#平滑后" class="headerlink" title="平滑后"></a>平滑后</h4><p><img src="./after.gif" alt="./after.gif"></p>
<h3 id="2-拉格朗日插值代码-参考cesium源码"><a href="#2-拉格朗日插值代码-参考cesium源码" class="headerlink" title="2 拉格朗日插值代码:(参考cesium源码)"></a>2 拉格朗日插值代码:(参考cesium源码)</h3><p>结合拉格朗日原理：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/135229305">https://zhuanlan.zhihu.com/p/135229305</a></p>
<p>源码如下：<a target="_blank" rel="noopener" href="https://github.com/CesiumGS/cesium/blob/b30/Source/Core/LagrangePolynomialApproximation.js#L39">https://github.com/CesiumGS/cesium/blob/b30/Source/Core/LagrangePolynomialApproximation.js#L39</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interpolates values using Lagrange Polynomial Approximation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; x The independent variable for which the dependent variables will be interpolated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number[]</span>&#125; xTable The array of independent variables to use to interpolate.  The values</span></span><br><span class="line"><span class="comment"> * in this array must be in increasing order and the same value must not occur twice in the array.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number[]</span>&#125; yTable The array of dependent variables to use to interpolate.  For a set of three</span></span><br><span class="line"><span class="comment"> * dependent values (p,q,w) at time 1 and time 2 this should be as follows: &#123;p1, q1, w1, p2, q2, w2&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; yStride The number of dependent variable values in yTable corresponding to</span></span><br><span class="line"><span class="comment"> * each independent variable value in xTable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number[]</span>&#125; [result] An existing array into which to store the result.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Number[]</span>&#125; The array of interpolated values, or the result parameter if one was provided.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">LagrangePolynomialApproximation</span>.<span class="property">interpolateOrderZero</span> = <span class="keyword">function</span>(<span class="params">x, xTable, yTable, yStride, result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">defined</span>(result)) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> <span class="title class_">Array</span>(yStride);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i;</span><br><span class="line">    <span class="keyword">var</span> j;</span><br><span class="line">    <span class="keyword">var</span> length = xTable.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; yStride; i++) &#123;</span><br><span class="line">        result[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> coefficient = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j !== i) &#123;</span><br><span class="line">                <span class="keyword">var</span> diffX = xTable[i] - xTable[j];</span><br><span class="line">                coefficient *= (x - xTable[j]) / diffX;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; yStride; j++) &#123;</span><br><span class="line">            result[j] += coefficient * yTable[i * yStride + j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="3-cesium中实现代码"><a href="#3-cesium中实现代码" class="headerlink" title="3 cesium中实现代码"></a>3 cesium中实现代码</h3><p>放入<a target="_blank" rel="noopener" href="https://sandcastle.cesium.com/index.html?src=Callback%20Property.html">https://sandcastle.cesium.com/index.html?src=Callback%20Property.html</a>运行即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This example illustrates a Callback Property, a property whose</span></span><br><span class="line"><span class="comment">// value is lazily evaluated by a callback function.</span></span><br><span class="line"><span class="comment">// Use a CallbackProperty when your data can&#x27;t be pre-computed</span></span><br><span class="line"><span class="comment">// or needs to be derived from other properties at runtime.</span></span><br><span class="line"><span class="keyword">var</span> viewer = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Viewer</span>(<span class="string">&quot;cesiumContainer&quot;</span>);</span><br><span class="line">viewer.<span class="property">clock</span>.<span class="property">shouldAnimate</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> startLatitude = <span class="number">35</span>;</span><br><span class="line"><span class="keyword">var</span> startLongitude = -<span class="number">120</span>;</span><br><span class="line"><span class="keyword">var</span> endLongitude;</span><br><span class="line"><span class="keyword">var</span> startTime = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="keyword">var</span> stTime = startTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Add a polyline to the scene. Positions are dynamic.</span></span><br><span class="line"><span class="keyword">var</span> isConstant = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> redLine = viewer.<span class="property">entities</span>.<span class="title function_">add</span>(&#123;</span><br><span class="line">  <span class="attr">polyline</span>: &#123;</span><br><span class="line">    <span class="comment">// This callback updates positions each frame.</span></span><br><span class="line">    <span class="attr">positions</span>: <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">CallbackProperty</span>(<span class="keyword">function</span> (<span class="params">time, result</span>) &#123;</span><br><span class="line">      endLongitude =</span><br><span class="line">        startLongitude +</span><br><span class="line">        <span class="number">0.001</span> * <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(time, startTime);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 平滑前效果</span></span><br><span class="line">      <span class="comment">// return computeCirclularFlight(-112.110693, 36.0994841, 0.03, time);</span></span><br><span class="line">      <span class="comment">// 平滑后效果</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">computeCirclularFlightSmoothly</span>(-<span class="number">112.110693</span>, <span class="number">36.0994841</span>, <span class="number">0.03</span>, <span class="number">500</span>, stTime, time);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      return Cesium.Cartesian3.fromDegreesArray(</span></span><br><span class="line"><span class="comment">        [startLongitude, startLatitude, endLongitude, startLatitude],</span></span><br><span class="line"><span class="comment">        Cesium.Ellipsoid.WGS84,</span></span><br><span class="line"><span class="comment">        result</span></span><br><span class="line"><span class="comment">      );</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    &#125;, isConstant),</span><br><span class="line">    <span class="attr">width</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">material</span>: <span class="title class_">Cesium</span>.<span class="property">Color</span>.<span class="property">RED</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Generate a random circular pattern with varying heights.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">computeCirclularFlight</span>(<span class="params">lon, lat, radius, curTime</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// let a = JulianDate.secondsDifference(JulianDate.now(), stTime);</span></span><br><span class="line">         <span class="keyword">let</span> positions = [];</span><br><span class="line">        <span class="comment">// Generate a random circular pattern with letying heights.</span></span><br><span class="line">        <span class="keyword">let</span> property = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">SampledPositionProperty</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="number">360</span>; i += <span class="number">45</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> radians = <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(i);</span><br><span class="line">            <span class="keyword">let</span> time = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(</span><br><span class="line">                stTime,</span><br><span class="line">                i,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">let</span> position = <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">                lon + radius * <span class="number">1.5</span> * <span class="title class_">Math</span>.<span class="title function_">cos</span>(radians),</span><br><span class="line">                lat + radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(radians),</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">nextRandomNumber</span>() * <span class="number">500</span> + </span><br><span class="line">                    <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">20</span> * <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(curTime, stTime)</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">            positions.<span class="title function_">push</span>(position);</span><br><span class="line">            property.<span class="title function_">addSample</span>(time, position);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> positions;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate a random circular pattern with varying heights.</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">computeCirclularFlightSmoothly</span>(<span class="params">lon, lat, radius, levelHeight, stTime, curTime</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// let a = JulianDate.secondsDifference(JulianDate.now(), stTime);</span></span><br><span class="line">        <span class="keyword">let</span> positions = [];</span><br><span class="line">        <span class="keyword">let</span> llhPositions = [];</span><br><span class="line">        <span class="comment">// let property = new PositionProperty();</span></span><br><span class="line">        <span class="comment">// Generate a random circular pattern with letying heights.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="number">360</span>; i += <span class="number">45</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> radians = <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">toRadians</span>(i);</span><br><span class="line">            <span class="keyword">let</span> time = <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">addSeconds</span>(</span><br><span class="line">                stTime,</span><br><span class="line">                i,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">JulianDate</span>()</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> tmpPoint = <span class="keyword">new</span> <span class="title class_">Cesium</span>.<span class="title class_">Cartographic</span>(</span><br><span class="line">                lon + radius * <span class="number">1.5</span> * <span class="title class_">Math</span>.<span class="title function_">cos</span>(radians),</span><br><span class="line">                lat + radius * <span class="title class_">Math</span>.<span class="title function_">sin</span>(radians),</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">nextRandomNumber</span>() * <span class="number">0.1</span> * levelHeight + levelHeight +</span><br><span class="line">                    <span class="title class_">Cesium</span>.<span class="property">Math</span>.<span class="title function_">random</span>() * <span class="number">20</span> * <span class="title class_">Cesium</span>.<span class="property">JulianDate</span>.<span class="title function_">secondsDifference</span>(curTime, stTime)</span><br><span class="line">            );</span><br><span class="line">            llhPositions.<span class="title function_">push</span>(tmpPoint);</span><br><span class="line">            positions.<span class="title function_">push</span>(</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">                    tmpPoint.<span class="property">longitude</span>,</span><br><span class="line">                    tmpPoint.<span class="property">latitude</span>,</span><br><span class="line">                    tmpPoint.<span class="property">height</span></span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// let iptPositions = Array&lt;Cartographic&gt;();</span></span><br><span class="line">        <span class="keyword">let</span> iptPositions = [];</span><br><span class="line">        <span class="keyword">let</span> xRes = [];</span><br><span class="line">        <span class="keyword">let</span> xTable = [];        <span class="comment">// interpolate at xTable[i]</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> ix = <span class="number">0</span>; ix &lt; positions.<span class="property">length</span>; ++ix) &#123;</span><br><span class="line">            xTable.<span class="title function_">push</span>(ix * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> yTable = [];        <span class="comment">// used to interpolate, in &#123;la1, lon1, h1, l2, lon2, h2&#125;</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> iy = <span class="number">0</span>; iy &lt; positions.<span class="property">length</span>; ++iy) &#123;</span><br><span class="line">            yTable.<span class="title function_">push</span>(llhPositions[iy].<span class="property">longitude</span>);</span><br><span class="line">            yTable.<span class="title function_">push</span>(llhPositions[iy].<span class="property">latitude</span>);</span><br><span class="line">            yTable.<span class="title function_">push</span>(llhPositions[iy].<span class="property">height</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> yStride = <span class="number">3</span>;        <span class="comment">// 3 dependent vaule in yTable is viewed as one item</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> ix = <span class="number">0</span>; ix &lt; xTable[positions.<span class="property">length</span> - <span class="number">1</span>]; ++ix) &#123;</span><br><span class="line">            <span class="keyword">let</span> iptRes = [];</span><br><span class="line">            <span class="title class_">Cesium</span>.<span class="property">LagrangePolynomialApproximation</span>.<span class="title function_">interpolateOrderZero</span>(</span><br><span class="line">                ix,</span><br><span class="line">                xTable,</span><br><span class="line">                yTable,</span><br><span class="line">                yStride,</span><br><span class="line">                iptRes</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            iptPositions.<span class="title function_">push</span>(</span><br><span class="line">                <span class="title class_">Cesium</span>.<span class="property">Cartesian3</span>.<span class="title function_">fromDegrees</span>(</span><br><span class="line">                iptRes[<span class="number">0</span>],</span><br><span class="line">                iptRes[<span class="number">1</span>],</span><br><span class="line">                iptRes[<span class="number">2</span>]</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  iptPositions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Keep the view centered.</span></span><br><span class="line">viewer.<span class="property">trackedEntity</span> = redLine;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xychen5</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
